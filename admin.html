<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지 - Marketing Cost Compilater</title>
    <link rel="icon" type="image/png" href="image/symbol_white.png">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 - 관리자용 다크 테마 */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-badge {
            display: inline-block;
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 12px;
            text-transform: uppercase;
            box-shadow: 0 2px 10px rgba(233, 69, 96, 0.4);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.7;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            gap: 12px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
            border-left-color: #e94560;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .nav-item span {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info-sidebar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: #e94560;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-details .name {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-details .role {
            font-size: 11px;
            opacity: 0.7;
        }

        .logout-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #e94560;
        }

        /* 메인 콘텐츠 */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            color: #1a1a2e;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #666;
            font-size: 14px;
        }

        .content-area {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(26, 26, 46, 0.3);
        }

        .stat-card h3 {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
        }

        .btn {
            background: #e94560;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #d63850;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .section-title {
            color: #1a1a2e;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* 테이블 스타일 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-size: 13px;
            font-weight: 600;
            color: #1a1a2e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            font-size: 14px;
            color: #333;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table .actions {
            display: flex;
            gap: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.admin {
            background: #ffe0e6;
            color: #e94560;
        }

        /* 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #001236;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* 이미지 미리보기 버튼 */
        .btn-preview {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            color: #004085;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-preview:hover {
            background: #cce5ff;
            border-color: #99caff;
        }

        /* 이미지 미리보기 모달 */
        .image-modal {
            background: rgba(0, 0, 0, 0.95);
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .image-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .image-modal-header h3 {
            font-size: 16px;
            font-weight: 500;
        }

        .image-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
        }

        .image-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .image-modal-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            min-height: 400px;
        }

        .image-modal-body img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .image-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
        }

        .image-nav-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .image-nav-btn.prev {
            left: 20px;
        }

        .image-nav-btn.next {
            right: 20px;
        }

        .image-modal-footer {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
        }

        .image-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: background 0.2s;
        }

        .image-dot.active {
            background: #f07c00;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #e94560;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* 헤더 액션 */
        .page-header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* 선택된 행 */
        .data-table tbody tr.selected {
            background: #ffe0e6;
        }

        /* 액션 바 */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .action-bar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .action-bar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-bar span {
            font-size: 14px;
            color: #666;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        /* 탭 스타일 */
        .tab-container {
            margin-bottom: 24px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 24px;
        }

        .tab-button {
            padding: 14px 24px;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: #1a1a2e;
        }

        .tab-button.active {
            color: #e94560;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #e94560;
            border-radius: 2px 2px 0 0;
        }

        .tab-content {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Round 관리 스타일 */
        .round-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .round-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .round-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #001236;
        }

        .round-date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .branch-cost-table {
            width: 100%;
            border-collapse: collapse;
        }

        .branch-cost-table th,
        .branch-cost-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .branch-cost-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #001236;
        }

        .branch-cost-table .amount {
            font-weight: 600;
            color: #001236;
        }

        /* 설정 페이지 스타일 */
        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .settings-item-info h4 {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }

        .settings-item-info p {
            font-size: 12px;
            color: #666;
        }

        /* 로딩 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 16px;
            color: #666;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar-header h1,
            .sidebar-header p,
            .nav-item span,
            .user-details,
            .logout-btn span {
                display: none;
            }

            .nav-item {
                justify-content: center;
                padding: 14px;
            }

            .main-content {
                margin-left: 70px;
                padding: 20px;
            }

            .user-info-sidebar {
                justify-content: center;
            }

            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">로딩 중...</div>
    </div>

    <!-- Firebase 설정 -->
    <script src="firebase.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const ADMIN_EMAIL = 'admin@dshare.co.kr';
        
        // 사용자 생성 중 플래그 (전역 - onAuthStateChanged 콜백에서 접근 가능하도록)
        let isCreatingUser = false;

        // 아이콘 컴포넌트
        const Icons = {
            Cost: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
            ),
            Round: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            ),
            Users: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            ),
            Settings: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            )
        };

        // 날짜 포맷
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 카테고리 정보
        const categories = {
            online: { label: '온라인 광고', className: 'online' },
            offline: { label: '오프라인 광고', className: 'offline' },
            event: { label: '이벤트/프로모션', className: 'event' },
            material: { label: '홍보물 제작', className: 'material' },
            other: { label: '기타', className: 'other' }
        };

        // 마케팅 비용 페이지
        function MarketingCostPage() {
            const [costs, setCosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [branches, setBranches] = useState([]);
            const [selectedBranch, setSelectedBranch] = useState('all');
            
            // 날짜 필터 상태
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            
            // 선택 및 삭제 관련 상태
            const [selectedCosts, setSelectedCosts] = useState([]);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [deletePassword, setDeletePassword] = useState('');
            const [isDeleting, setIsDeleting] = useState(false);
            
            // 이미지 미리보기 모달 상태
            const [showImageModal, setShowImageModal] = useState(false);
            const [previewImages, setPreviewImages] = useState([]);
            const [currentImageIndex, setCurrentImageIndex] = useState(0);
            
            // Round 관련 상태
            const [currentRound, setCurrentRound] = useState(null);
            const [totalBudget, setTotalBudget] = useState(0);
            const [branchBudgets, setBranchBudgets] = useState({});

            // 금액 포맷
            const formatAmount = (amount) => {
                return new Intl.NumberFormat('ko-KR', {
                    style: 'currency',
                    currency: 'KRW'
                }).format(amount);
            };

            // 금액 포맷 (엑셀용 - 숫자만)
            const formatAmountForExcel = (amount) => {
                return Number(amount || 0);
            };

            // 날짜 포맷 (비용용)
            const formatCostDate = (dateValue) => {
                if (!dateValue) return '-';
                const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };

            // 날짜 포맷 (엑셀용)
            const formatDateForExcel = (dateValue) => {
                if (!dateValue) return '';
                const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
                return date.toLocaleDateString('ko-KR');
            };

            // Firestore에서 모든 비용 로드
            useEffect(() => {
                const unsubscribe = db.collection('costs')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const costsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setCosts(costsData);
                        
                        // 지점 목록 추출
                        const branchSet = new Set();
                        costsData.forEach(cost => {
                            if (cost.branchName) {
                                branchSet.add(cost.branchName);
                            }
                        });
                        setBranches([...branchSet].sort());
                        setLoading(false);
                    }, (error) => {
                        console.error('비용 목록 로드 오류:', error);
                        setLoading(false);
                    });

                return () => unsubscribe();
            }, []);

            // 현재 진행 중인 Round와 배정 비용 로드
            useEffect(() => {
                const today = new Date().toISOString().split('T')[0];

                const roundsUnsubscribe = db.collection('rounds')
                    .onSnapshot(async (snapshot) => {
                        const roundsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));

                        // 현재 날짜가 포함된 Round 찾기
                        const activeRound = roundsData.find(round => {
                            return today >= round.startDate && today <= round.endDate;
                        });

                        if (activeRound) {
                            setCurrentRound(activeRound);

                            // 해당 Round의 전체 배정 비용 가져오기
                            try {
                                const budgetDoc = await db.collection('roundBudgets').doc(activeRound.id).get();
                                if (budgetDoc.exists) {
                                    const budgets = budgetDoc.data().budgets || {};
                                    setBranchBudgets(budgets);
                                    // 전체 배정 비용 합계
                                    const total = Object.values(budgets).reduce((sum, val) => sum + Number(val || 0), 0);
                                    setTotalBudget(total);
                                }
                            } catch (error) {
                                console.error('배정 비용 로드 오류:', error);
                            }
                        } else {
                            setCurrentRound(null);
                            setTotalBudget(0);
                            setBranchBudgets({});
                        }
                    });

                return () => roundsUnsubscribe();
            }, []);

            // Round 기간 내 사용 비용 계산 (전체)
            const getRoundUsedAmount = () => {
                if (!currentRound) return 0;
                
                return costs.filter(cost => {
                    const costDate = cost.date;
                    return costDate >= currentRound.startDate && costDate <= currentRound.endDate;
                }).reduce((sum, cost) => sum + Number(cost.amount || 0), 0);
            };

            // Round 기간 내 지점별 사용 비용 계산
            const getRoundUsedByBranch = (branchName) => {
                if (!currentRound) return 0;
                
                return costs.filter(cost => {
                    if (cost.branchName !== branchName) return false;
                    const costDate = cost.date;
                    return costDate >= currentRound.startDate && costDate <= currentRound.endDate;
                }).reduce((sum, cost) => sum + Number(cost.amount || 0), 0);
            };

            // 필터링된 비용
            // 필터링된 비용 목록
            const filteredCosts = costs.filter(cost => {
                // 지점 필터
                if (selectedBranch !== 'all' && cost.branchName !== selectedBranch) {
                    return false;
                }
                
                // 날짜 필터 (cost.date 기준)
                if (startDate || endDate) {
                    const costDate = new Date(cost.date);
                    
                    if (startDate) {
                        const start = new Date(startDate);
                        start.setHours(0, 0, 0, 0);
                        if (costDate < start) return false;
                    }
                    
                    if (endDate) {
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999);
                        if (costDate > end) return false;
                    }
                }
                
                return true;
            });
            
            // 필터 초기화
            const handleResetFilters = () => {
                setSelectedBranch('all');
                setStartDate('');
                setEndDate('');
            };

            // 체크박스 - 개별 선택
            const handleSelectCost = (id) => {
                setSelectedCosts(prev => {
                    if (prev.includes(id)) {
                        return prev.filter(costId => costId !== id);
                    } else {
                        return [...prev, id];
                    }
                });
            };

            // 체크박스 - 전체 선택
            const handleSelectAll = () => {
                if (selectedCosts.length === filteredCosts.length) {
                    setSelectedCosts([]);
                } else {
                    setSelectedCosts(filteredCosts.map(cost => cost.id));
                }
            };

            // 삭제 모달 열기
            const openDeleteModal = () => {
                if (selectedCosts.length === 0) {
                    alert('삭제할 항목을 선택해주세요.');
                    return;
                }
                setDeletePassword('');
                setShowDeleteModal(true);
            };

            // 이미지 미리보기 열기
            const openImagePreview = (images) => {
                if (!images || images.length === 0) {
                    alert('등록된 이미지가 없습니다.');
                    return;
                }
                setPreviewImages(images);
                setCurrentImageIndex(0);
                setShowImageModal(true);
            };

            // 이전/다음 이미지
            const handlePrevImage = () => {
                setCurrentImageIndex(prev => prev > 0 ? prev - 1 : previewImages.length - 1);
            };

            const handleNextImage = () => {
                setCurrentImageIndex(prev => prev < previewImages.length - 1 ? prev + 1 : 0);
            };

            // 비밀번호 확인 후 삭제 실행
            const handleConfirmDelete = async (e) => {
                e.preventDefault();
                
                if (!deletePassword) {
                    alert('비밀번호를 입력해주세요.');
                    return;
                }

                setIsDeleting(true);

                try {
                    // 관리자 비밀번호 확인 (재인증)
                    const adminUser = auth.currentUser;
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        adminUser.email,
                        deletePassword
                    );
                    await adminUser.reauthenticateWithCredential(credential);

                    // 선택된 비용의 이미지도 함께 삭제
                    for (const costId of selectedCosts) {
                        const costData = costs.find(c => c.id === costId);
                        if (costData && costData.userId) {
                            await deleteCostImages(costData.userId, costId);
                        }
                    }

                    // Firestore에서 비용 데이터 삭제
                    const batch = db.batch();
                    selectedCosts.forEach(id => {
                        const docRef = db.collection('costs').doc(id);
                        batch.delete(docRef);
                    });
                    await batch.commit();

                    alert(`${selectedCosts.length}개 항목이 삭제되었습니다.`);
                    setSelectedCosts([]);
                    setShowDeleteModal(false);
                } catch (error) {
                    console.error('삭제 오류:', error);
                    if (error.code === 'auth/wrong-password') {
                        alert('비밀번호가 올바르지 않습니다.');
                    } else {
                        alert('삭제에 실패했습니다: ' + error.message);
                    }
                } finally {
                    setIsDeleting(false);
                    setDeletePassword('');
                }
            };

            // 엑셀 다운로드
            const handleExportExcel = () => {
                const dataToExport = selectedCosts.length > 0 
                    ? filteredCosts.filter(cost => selectedCosts.includes(cost.id))
                    : filteredCosts;

                if (dataToExport.length === 0) {
                    alert('내보낼 데이터가 없습니다.');
                    return;
                }

                // CSV 데이터 생성
                const headers = ['지점', '날짜', '항목', '금액', '설명', '등록자', '등록일시'];
                const rows = dataToExport.map(cost => [
                    cost.branchName || '미설정',
                    formatDateForExcel(cost.date),
                    categories[cost.category]?.label || cost.category,
                    formatAmountForExcel(cost.amount),
                    cost.description || '',
                    cost.userEmail || '',
                    formatDateForExcel(cost.createdAt)
                ]);

                // BOM 추가 (한글 깨짐 방지)
                const BOM = '\uFEFF';
                const csvContent = BOM + [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                ].join('\n');

                // 파일 다운로드
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                const fileName = `마케팅비용_${selectedBranch === 'all' ? '전체' : selectedBranch}_${new Date().toLocaleDateString('ko-KR').replace(/\./g, '')}.csv`;
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // 이번 달 비용 계산
            const getMonthlyTotal = () => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                return filteredCosts
                    .filter(cost => {
                        const costDate = cost.date ? new Date(cost.date) : null;
                        return costDate && costDate.getMonth() === currentMonth && costDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, cost) => sum + Number(cost.amount || 0), 0);
            };

            // 총 비용 계산
            const getTotalAmount = () => {
                return filteredCosts.reduce((sum, cost) => sum + Number(cost.amount || 0), 0);
            };

            if (loading) {
                return (
                    <div className="loading-spinner">
                        <p>비용 데이터를 불러오는 중...</p>
                    </div>
                );
            }

            return (
                <div>
                    <div className="page-header">
                        <h2 className="page-title">마케팅 비용</h2>
                        <p className="page-subtitle">전체 지점의 마케팅 비용을 관리합니다</p>
                    </div>

                    {/* 현재 Round 정보 카드 */}
                    {currentRound && totalBudget > 0 && (
                        <div style={{
                            background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
                            borderRadius: '12px',
                            padding: '24px',
                            marginBottom: '20px',
                            color: 'white'
                        }}>
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginBottom: '16px'
                            }}>
                                <div>
                                    <div style={{
                                        display: 'inline-block',
                                        background: '#e94560',
                                        padding: '4px 10px',
                                        borderRadius: '4px',
                                        fontSize: '11px',
                                        fontWeight: '700',
                                        marginBottom: '8px'
                                    }}>
                                        현재 진행중
                                    </div>
                                    <h3 style={{fontSize: '18px', fontWeight: '700', marginBottom: '4px'}}>
                                        {currentRound.name}
                                    </h3>
                                    <p style={{fontSize: '13px', opacity: 0.7}}>
                                        {currentRound.startDate} ~ {currentRound.endDate}
                                    </p>
                                </div>
                                <div style={{
                                    background: getRoundUsedAmount() > totalBudget ? '#dc3545' : '#e94560',
                                    padding: '8px 16px',
                                    borderRadius: '20px',
                                    fontSize: '14px',
                                    fontWeight: '700'
                                }}>
                                    {totalBudget > 0 ? Math.round((getRoundUsedAmount() / totalBudget) * 100) : 0}% 소진
                                </div>
                            </div>
                            
                            {/* 프로그레스 바 */}
                            <div style={{
                                background: 'rgba(255,255,255,0.2)',
                                borderRadius: '10px',
                                height: '14px',
                                marginBottom: '20px',
                                overflow: 'hidden'
                            }}>
                                <div style={{
                                    width: `${Math.min((getRoundUsedAmount() / totalBudget) * 100, 100)}%`,
                                    height: '100%',
                                    background: getRoundUsedAmount() > totalBudget 
                                        ? 'linear-gradient(90deg, #dc3545, #ff6b6b)' 
                                        : 'linear-gradient(90deg, #e94560, #ff6b6b)',
                                    transition: 'width 0.5s ease'
                                }} />
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '16px'}}>
                                <div>
                                    <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>총 배정 예산</div>
                                    <div style={{fontSize: '22px', fontWeight: '700'}}>{formatAmount(totalBudget)}</div>
                                </div>
                                <div>
                                    <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>총 사용 비용</div>
                                    <div style={{fontSize: '22px', fontWeight: '700'}}>{formatAmount(getRoundUsedAmount())}</div>
                                </div>
                                <div>
                                    <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>잔여 예산</div>
                                    <div style={{
                                        fontSize: '22px', 
                                        fontWeight: '700',
                                        color: totalBudget - getRoundUsedAmount() < 0 ? '#ff6b6b' : '#4ade80'
                                    }}>
                                        {formatAmount(totalBudget - getRoundUsedAmount())}
                                    </div>
                                </div>
                                <div>
                                    <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>배정 지점 수</div>
                                    <div style={{fontSize: '22px', fontWeight: '700'}}>
                                        {Object.keys(branchBudgets).filter(k => branchBudgets[k] > 0).length}개
                                    </div>
                                </div>
                            </div>

                            {/* 지점별 소진율 미니 테이블 */}
                            {Object.keys(branchBudgets).length > 0 && (
                                <div style={{
                                    marginTop: '20px',
                                    paddingTop: '20px',
                                    borderTop: '1px solid rgba(255,255,255,0.1)'
                                }}>
                                    <div style={{fontSize: '13px', fontWeight: '600', marginBottom: '12px', opacity: 0.9}}>
                                        지점별 소진율
                                    </div>
                                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '10px'}}>
                                        {Object.entries(branchBudgets)
                                            .filter(([_, budget]) => budget > 0)
                                            .map(([branch, budget]) => {
                                                const used = getRoundUsedByBranch(branch);
                                                const rate = budget > 0 ? Math.round((used / budget) * 100) : 0;
                                                return (
                                                    <div key={branch} style={{
                                                        background: 'rgba(255,255,255,0.1)',
                                                        borderRadius: '8px',
                                                        padding: '10px 12px'
                                                    }}>
                                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px'}}>
                                                            <span style={{fontSize: '13px', fontWeight: '600'}}>{branch}</span>
                                                            <span style={{
                                                                fontSize: '12px',
                                                                fontWeight: '700',
                                                                color: rate > 100 ? '#ff6b6b' : rate > 80 ? '#fbbf24' : '#4ade80'
                                                            }}>{rate}%</span>
                                                        </div>
                                                        <div style={{
                                                            background: 'rgba(255,255,255,0.2)',
                                                            borderRadius: '4px',
                                                            height: '6px',
                                                            overflow: 'hidden'
                                                        }}>
                                                            <div style={{
                                                                width: `${Math.min(rate, 100)}%`,
                                                                height: '100%',
                                                                background: rate > 100 ? '#dc3545' : rate > 80 ? '#fbbf24' : '#4ade80',
                                                                transition: 'width 0.3s'
                                                            }} />
                                                        </div>
                                                        <div style={{fontSize: '11px', opacity: 0.7, marginTop: '4px'}}>
                                                            {formatAmount(used)} / {formatAmount(budget)}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    <div className="stats-grid">
                        <div className="stat-card">
                            <h3>전체 지점 수</h3>
                            <div className="value">{branches.length}</div>
                        </div>
                        <div className="stat-card">
                            <h3>이번 달 총 비용</h3>
                            <div className="value">{formatAmount(getMonthlyTotal())}</div>
                        </div>
                        <div className="stat-card">
                            <h3>누적 총 비용</h3>
                            <div className="value">{formatAmount(getTotalAmount())}</div>
                        </div>
                    </div>

                    <div className="content-area">
                        <div className="page-header-actions">
                            <h3 className="section-title" style={{marginBottom: 0}}>비용 현황</h3>
                        </div>
                        
                        {/* 필터 영역 */}
                        <div style={{
                            display: 'flex', 
                            gap: '20px', 
                            alignItems: 'center',
                            flexWrap: 'wrap',
                            padding: '15px 20px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            marginBottom: '20px'
                        }}>
                            {/* 지점 필터 */}
                            <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                                <label style={{fontSize: '14px', color: '#666', fontWeight: '500'}}>지점:</label>
                                <select 
                                    value={selectedBranch}
                                    onChange={(e) => {
                                        setSelectedBranch(e.target.value);
                                        setSelectedCosts([]);
                                    }}
                                    style={{
                                        padding: '8px 12px',
                                        borderRadius: '6px',
                                        border: '2px solid #e0e0e0',
                                        fontSize: '14px',
                                        minWidth: '150px'
                                    }}
                                >
                                    <option value="all">전체 지점</option>
                                    {branches.map(branch => (
                                        <option key={branch} value={branch}>{branch}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* 날짜 필터 */}
                            <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                                <label style={{fontSize: '14px', color: '#666', fontWeight: '500'}}>등록 일시:</label>
                                <input 
                                    type="date"
                                    value={startDate}
                                    onChange={(e) => {
                                        setStartDate(e.target.value);
                                        setSelectedCosts([]);
                                    }}
                                    style={{
                                        padding: '8px 12px',
                                        borderRadius: '6px',
                                        border: '2px solid #e0e0e0',
                                        fontSize: '14px'
                                    }}
                                />
                                <span style={{color: '#999'}}>~</span>
                                <input 
                                    type="date"
                                    value={endDate}
                                    onChange={(e) => {
                                        setEndDate(e.target.value);
                                        setSelectedCosts([]);
                                    }}
                                    style={{
                                        padding: '8px 12px',
                                        borderRadius: '6px',
                                        border: '2px solid #e0e0e0',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            {/* 필터 초기화 버튼 */}
                            {(selectedBranch !== 'all' || startDate || endDate) && (
                                <button
                                    onClick={handleResetFilters}
                                    style={{
                                        padding: '8px 16px',
                                        borderRadius: '6px',
                                        border: 'none',
                                        background: '#6c757d',
                                        color: 'white',
                                        fontSize: '13px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    필터 초기화
                                </button>
                            )}
                            
                            {/* 필터 결과 및 엑셀 다운로드 */}
                            <div style={{marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: '15px'}}>
                                <span style={{fontSize: '14px', color: '#666'}}>
                                    총 <strong style={{color: '#001236'}}>{filteredCosts.length}</strong>건
                                </span>
                                <button 
                                    className="btn btn-sm btn-success" 
                                    onClick={handleExportExcel}
                                    style={{whiteSpace: 'nowrap'}}
                                >
                                    {selectedCosts.length > 0 ? `선택 ${selectedCosts.length}건 엑셀` : '전체 엑셀 다운로드'}
                                </button>
                            </div>
                        </div>

                        {filteredCosts.length === 0 ? (
                            <div className="empty-state">
                                <p>등록된 마케팅 비용 데이터가 없습니다.</p>
                            </div>
                        ) : (
                            <>
                                {/* 선택 시 액션 바 */}
                                {selectedCosts.length > 0 && (
                                    <div className="action-bar">
                                        <div className="action-bar-left">
                                            <span>{selectedCosts.length}개 선택됨</span>
                                        </div>
                                        <div className="action-bar-right">
                                            <button className="btn btn-sm btn-danger" onClick={openDeleteModal}>
                                                선택 삭제
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th style={{width: '50px'}}>
                                                <input 
                                                    type="checkbox"
                                                    checked={selectedCosts.length === filteredCosts.length && filteredCosts.length > 0}
                                                    onChange={handleSelectAll}
                                                    style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                                />
                                            </th>
                                            <th>지점</th>
                                            <th>날짜</th>
                                            <th>항목</th>
                                            <th>금액</th>
                                            <th>설명</th>
                                            <th>등록자</th>
                                            <th>등록일시</th>
                                            <th style={{width: '80px'}}>증빙</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredCosts.map(cost => (
                                            <tr key={cost.id} className={selectedCosts.includes(cost.id) ? 'selected' : ''}>
                                                <td>
                                                    <input 
                                                        type="checkbox"
                                                        checked={selectedCosts.includes(cost.id)}
                                                        onChange={() => handleSelectCost(cost.id)}
                                                        style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                                    />
                                                </td>
                                                <td>
                                                    <span style={{
                                                        background: '#f07c00',
                                                        color: 'white',
                                                        padding: '4px 10px',
                                                        borderRadius: '4px',
                                                        fontSize: '12px',
                                                        fontWeight: '600'
                                                    }}>
                                                        {cost.branchName || '미설정'}
                                                    </span>
                                                </td>
                                                <td>{formatCostDate(cost.date)}</td>
                                                <td>
                                                    <span className={`status-badge ${categories[cost.category]?.className || ''}`} style={{
                                                        background: cost.category === 'online' ? '#e3f2fd' :
                                                                   cost.category === 'offline' ? '#f3e5f5' :
                                                                   cost.category === 'event' ? '#fff3e0' :
                                                                   cost.category === 'material' ? '#e8f5e9' : '#eceff1',
                                                        color: cost.category === 'online' ? '#1976d2' :
                                                               cost.category === 'offline' ? '#7b1fa2' :
                                                               cost.category === 'event' ? '#f57c00' :
                                                               cost.category === 'material' ? '#388e3c' : '#546e7a'
                                                    }}>
                                                        {categories[cost.category]?.label || cost.category}
                                                    </span>
                                                </td>
                                                <td style={{fontWeight: '600', color: '#001236'}}>
                                                    {formatAmount(cost.amount)}
                                                </td>
                                                <td>{cost.description || '-'}</td>
                                                <td style={{fontSize: '12px', color: '#666'}}>
                                                    {cost.userEmail}
                                                </td>
                                                <td style={{fontSize: '12px', color: '#666'}}>
                                                    {formatDate(cost.createdAt)}
                                                </td>
                                                <td>
                                                    {cost.images && cost.images.length > 0 ? (
                                                        <button 
                                                            className="btn-preview"
                                                            onClick={() => openImagePreview(cost.images)}
                                                        >
                                                            📷 {cost.images.length}
                                                        </button>
                                                    ) : (
                                                        <span style={{color: '#999', fontSize: '12px'}}>-</span>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </>
                        )}
                    </div>

                    {/* 삭제 확인 모달 */}
                    {showDeleteModal && (
                        <div className="modal-overlay" onClick={() => setShowDeleteModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>삭제 확인</h3>
                                    <button className="modal-close" onClick={() => setShowDeleteModal(false)}>×</button>
                                </div>
                                <form onSubmit={handleConfirmDelete}>
                                    <div className="modal-body">
                                        <p style={{marginBottom: '15px', color: '#666'}}>
                                            선택한 <strong style={{color: '#dc3545'}}>{selectedCosts.length}개</strong> 항목을 삭제하려면 관리자 비밀번호를 입력하세요.
                                        </p>
                                        <div className="form-group">
                                            <label>관리자 비밀번호</label>
                                            <input 
                                                type="password"
                                                value={deletePassword}
                                                onChange={(e) => setDeletePassword(e.target.value)}
                                                placeholder="비밀번호를 입력하세요"
                                                required
                                                autoFocus
                                            />
                                        </div>
                                    </div>
                                    <div className="modal-actions" style={{padding: '15px 20px', borderTop: '1px solid #eee'}}>
                                        <button 
                                            type="button" 
                                            className="btn btn-secondary btn-sm"
                                            onClick={() => setShowDeleteModal(false)}
                                            disabled={isDeleting}
                                        >
                                            취소
                                        </button>
                                        <button 
                                            type="submit" 
                                            className="btn btn-danger btn-sm"
                                            disabled={isDeleting}
                                        >
                                            {isDeleting ? '삭제 중...' : '삭제'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* 이미지 미리보기 모달 */}
                    {showImageModal && previewImages.length > 0 && (
                        <div className="modal-overlay" onClick={() => setShowImageModal(false)}>
                            <div className="image-modal" onClick={(e) => e.stopPropagation()}>
                                <div className="image-modal-header">
                                    <h3>증빙 이미지 ({currentImageIndex + 1} / {previewImages.length})</h3>
                                    <button className="image-modal-close" onClick={() => setShowImageModal(false)}>
                                        ×
                                    </button>
                                </div>
                                <div className="image-modal-body">
                                    {previewImages.length > 1 && (
                                        <button className="image-nav-btn prev" onClick={handlePrevImage}>
                                            ‹
                                        </button>
                                    )}
                                    <img 
                                        src={previewImages[currentImageIndex]?.url} 
                                        alt={`증빙 이미지 ${currentImageIndex + 1}`}
                                    />
                                    {previewImages.length > 1 && (
                                        <button className="image-nav-btn next" onClick={handleNextImage}>
                                            ›
                                        </button>
                                    )}
                                </div>
                                {previewImages.length > 1 && (
                                    <div className="image-modal-footer">
                                        {previewImages.map((_, index) => (
                                            <div 
                                                key={index}
                                                className={`image-dot ${index === currentImageIndex ? 'active' : ''}`}
                                                onClick={() => setCurrentImageIndex(index)}
                                            />
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Round 관리 페이지
        function RoundManagementPage() {
            const [activeTab, setActiveTab] = useState('date');
            const [branches, setBranches] = useState([]);
            const [costs, setCosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [rounds, setRounds] = useState([]);
            const [newRound, setNewRound] = useState({
                name: '',
                startDate: '',
                endDate: ''
            });
            
            // 지점별 비용 배정 관련 상태
            const [selectedRoundId, setSelectedRoundId] = useState('');
            const [branchBudgets, setBranchBudgets] = useState({});
            const [isSavingBudget, setIsSavingBudget] = useState(false);

            // 금액 포맷
            const formatAmount = (amount) => {
                return new Intl.NumberFormat('ko-KR', {
                    style: 'currency',
                    currency: 'KRW'
                }).format(amount);
            };

            // 데이터 로드
            useEffect(() => {
                const loadData = async () => {
                    setLoading(true);
                    
                    // 사용자 목록에서 지점명 가져오기
                    const usersResult = await getAllUsers();
                    if (usersResult.success) {
                        const branchSet = new Set();
                        usersResult.users.forEach(user => {
                            if (user.branchName) {
                                branchSet.add(user.branchName);
                            }
                        });
                        setBranches([...branchSet].sort());
                    }

                    // 비용 데이터 로드
                    const unsubscribe = db.collection('costs')
                        .onSnapshot((snapshot) => {
                            const costsData = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setCosts(costsData);
                            setLoading(false);
                        });

                    // Round 목록 로드
                    const roundsUnsubscribe = db.collection('rounds')
                        .orderBy('createdAt', 'desc')
                        .onSnapshot((snapshot) => {
                            const roundsData = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setRounds(roundsData);
                        });

                    return () => {
                        unsubscribe();
                        roundsUnsubscribe();
                    };
                };

                loadData();
            }, []);

            // 지점별 비용 계산 (선택된 라운드 기간 내)
            const getBranchCosts = (branchName) => {
                const selectedRound = rounds.find(r => r.id === selectedRoundId);
                
                return costs
                    .filter(cost => {
                        if (cost.branchName !== branchName) return false;
                        
                        // 라운드가 선택된 경우 해당 기간 내 비용만 계산
                        if (selectedRound) {
                            const costDate = new Date(cost.date);
                            const startDate = new Date(selectedRound.startDate);
                            const endDate = new Date(selectedRound.endDate);
                            endDate.setHours(23, 59, 59, 999);
                            return costDate >= startDate && costDate <= endDate;
                        }
                        
                        return true;
                    })
                    .reduce((sum, cost) => sum + Number(cost.amount || 0), 0);
            };

            // 지점별 비용 건수 (선택된 라운드 기간 내)
            const getBranchCostCount = (branchName) => {
                const selectedRound = rounds.find(r => r.id === selectedRoundId);
                
                return costs.filter(cost => {
                    if (cost.branchName !== branchName) return false;
                    
                    if (selectedRound) {
                        const costDate = new Date(cost.date);
                        const startDate = new Date(selectedRound.startDate);
                        const endDate = new Date(selectedRound.endDate);
                        endDate.setHours(23, 59, 59, 999);
                        return costDate >= startDate && costDate <= endDate;
                    }
                    
                    return true;
                }).length;
            };

            // 라운드 선택 시 배정 비용 로드
            const handleRoundSelect = async (roundId) => {
                setSelectedRoundId(roundId);
                
                if (!roundId) {
                    setBranchBudgets({});
                    return;
                }
                
                try {
                    const doc = await db.collection('roundBudgets').doc(roundId).get();
                    if (doc.exists) {
                        setBranchBudgets(doc.data().budgets || {});
                    } else {
                        // 초기값 설정 (모든 지점 0원)
                        const initialBudgets = {};
                        branches.forEach(branch => {
                            initialBudgets[branch] = 0;
                        });
                        setBranchBudgets(initialBudgets);
                    }
                } catch (error) {
                    console.error('배정 비용 로드 오류:', error);
                    setBranchBudgets({});
                }
            };

            // 지점별 배정 비용 변경
            const handleBudgetChange = (branch, value) => {
                const numericValue = value.replace(/[^\d]/g, '');
                setBranchBudgets(prev => ({
                    ...prev,
                    [branch]: Number(numericValue) || 0
                }));
            };

            // 배정 비용 저장
            const handleSaveBudgets = async () => {
                if (!selectedRoundId) {
                    alert('라운드를 선택해주세요.');
                    return;
                }
                
                setIsSavingBudget(true);
                
                try {
                    await db.collection('roundBudgets').doc(selectedRoundId).set({
                        roundId: selectedRoundId,
                        budgets: branchBudgets,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('배정 비용이 저장되었습니다.');
                } catch (error) {
                    console.error('배정 비용 저장 오류:', error);
                    alert('배정 비용 저장에 실패했습니다.');
                } finally {
                    setIsSavingBudget(false);
                }
            };

            // 금액 입력 포맷
            const formatBudgetInput = (value) => {
                return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            };

            // 전체 배정 비용 합계
            const getTotalBudget = () => {
                return Object.values(branchBudgets).reduce((sum, val) => sum + Number(val || 0), 0);
            };

            // Round 추가
            const handleAddRound = async (e) => {
                e.preventDefault();
                
                if (!newRound.name || !newRound.startDate || !newRound.endDate) {
                    alert('모든 필드를 입력해주세요.');
                    return;
                }

                try {
                    await db.collection('rounds').add({
                        name: newRound.name,
                        startDate: newRound.startDate,
                        endDate: newRound.endDate,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setNewRound({ name: '', startDate: '', endDate: '' });
                    alert('Round가 추가되었습니다.');
                } catch (error) {
                    console.error('Round 추가 오류:', error);
                    alert('Round 추가에 실패했습니다.');
                }
            };

            // Round 삭제
            const handleDeleteRound = async (roundId) => {
                if (!confirm('이 Round를 삭제하시겠습니까?')) return;
                
                try {
                    await db.collection('rounds').doc(roundId).delete();
                    alert('Round가 삭제되었습니다.');
                } catch (error) {
                    console.error('Round 삭제 오류:', error);
                    alert('Round 삭제에 실패했습니다.');
                }
            };

            if (loading) {
                return (
                    <div className="loading-spinner">
                        <p>데이터를 불러오는 중...</p>
                    </div>
                );
            }

            return (
                <div>
                    <div className="page-header">
                        <h2 className="page-title">Round 관리</h2>
                        <p className="page-subtitle">Round 기간 설정 및 지점별 비용을 관리합니다</p>
                    </div>

                    <div className="content-area">
                        {/* 탭 버튼 */}
                        <div className="tab-buttons">
                            <button 
                                className={`tab-button ${activeTab === 'date' ? 'active' : ''}`}
                                onClick={() => setActiveTab('date')}
                            >
                                Round 날짜 지정
                            </button>
                            <button 
                                className={`tab-button ${activeTab === 'branch' ? 'active' : ''}`}
                                onClick={() => setActiveTab('branch')}
                            >
                                지점별 비용
                            </button>
                        </div>

                        {/* 탭 컨텐츠 */}
                        <div className="tab-content">
                            {activeTab === 'date' && (
                                <div>
                                    {/* Round 추가 폼 */}
                                    <div className="round-card">
                                        <div className="round-card-header">
                                            <h4 className="round-card-title">새 Round 추가</h4>
                                        </div>
                                        <form onSubmit={handleAddRound}>
                                            <div className="form-group" style={{marginBottom: '16px'}}>
                                                <label>Round 이름</label>
                                                <input 
                                                    type="text"
                                                    value={newRound.name}
                                                    onChange={(e) => setNewRound({...newRound, name: e.target.value})}
                                                    placeholder="예: 2025년 1Round"
                                                />
                                            </div>
                                            <div className="round-date-inputs">
                                                <div className="form-group">
                                                    <label>시작일</label>
                                                    <input 
                                                        type="date"
                                                        value={newRound.startDate}
                                                        onChange={(e) => setNewRound({...newRound, startDate: e.target.value})}
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>종료일</label>
                                                    <input 
                                                        type="date"
                                                        value={newRound.endDate}
                                                        onChange={(e) => setNewRound({...newRound, endDate: e.target.value})}
                                                    />
                                                </div>
                                            </div>
                                            <button type="submit" className="btn" style={{marginTop: '16px'}}>
                                                Round 추가
                                            </button>
                                        </form>
                                    </div>

                                    {/* Round 목록 */}
                                    <h4 style={{marginBottom: '16px', color: '#001236'}}>등록된 Round 목록</h4>
                                    {rounds.length === 0 ? (
                                        <p style={{color: '#666'}}>등록된 Round가 없습니다.</p>
                                    ) : (
                                        rounds.map(round => (
                                            <div key={round.id} className="round-card">
                                                <div className="round-card-header">
                                                    <h4 className="round-card-title">{round.name}</h4>
                                                    <button 
                                                        className="btn btn-sm btn-danger"
                                                        onClick={() => handleDeleteRound(round.id)}
                                                    >
                                                        삭제
                                                    </button>
                                                </div>
                                                <p style={{color: '#666', fontSize: '14px'}}>
                                                    {round.startDate} ~ {round.endDate}
                                                </p>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}

                            {activeTab === 'branch' && (
                                <div>
                                    {/* 라운드 선택 */}
                                    <div className="round-card" style={{marginBottom: '24px'}}>
                                        <div className="round-card-header">
                                            <h4 className="round-card-title">Round 선택</h4>
                                        </div>
                                        <div style={{display: 'flex', gap: '16px', alignItems: 'center'}}>
                                            <select
                                                value={selectedRoundId}
                                                onChange={(e) => handleRoundSelect(e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '12px 16px',
                                                    borderRadius: '8px',
                                                    border: '2px solid #e0e0e0',
                                                    fontSize: '14px'
                                                }}
                                            >
                                                <option value="">-- Round를 선택하세요 --</option>
                                                {rounds.map(round => (
                                                    <option key={round.id} value={round.id}>
                                                        {round.name} ({round.startDate} ~ {round.endDate})
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        {rounds.length === 0 && (
                                            <p style={{color: '#999', fontSize: '13px', marginTop: '10px'}}>
                                                먼저 "Round 날짜 지정" 탭에서 Round를 생성해주세요.
                                            </p>
                                        )}
                                    </div>

                                    {selectedRoundId ? (
                                        <>
                                            {/* 통계 카드 */}
                                            <div className="stats-grid" style={{marginBottom: '24px'}}>
                                                <div className="stat-card">
                                                    <h3>전체 지점 수</h3>
                                                    <div className="value">{branches.length}</div>
                                                </div>
                                                <div className="stat-card">
                                                    <h3>총 배정 비용</h3>
                                                    <div className="value">{formatAmount(getTotalBudget())}</div>
                                                </div>
                                                <div className="stat-card">
                                                    <h3>총 사용 비용</h3>
                                                    <div className="value">
                                                        {formatAmount(branches.reduce((sum, b) => sum + getBranchCosts(b), 0))}
                                                    </div>
                                                </div>
                                            </div>

                                            {branches.length === 0 ? (
                                                <p style={{color: '#666'}}>등록된 지점이 없습니다. 사용자 관리에서 지점명을 설정해주세요.</p>
                                            ) : (
                                                <>
                                                    <table className="branch-cost-table">
                                                        <thead>
                                                            <tr>
                                                                <th>지점명</th>
                                                                <th style={{width: '180px'}}>배정 비용</th>
                                                                <th>사용 비용</th>
                                                                <th>잔여 비용</th>
                                                                <th>사용률</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {branches.map(branch => {
                                                                const budget = branchBudgets[branch] || 0;
                                                                const used = getBranchCosts(branch);
                                                                const remaining = budget - used;
                                                                const usageRate = budget > 0 ? Math.round((used / budget) * 100) : 0;
                                                                
                                                                return (
                                                                    <tr key={branch}>
                                                                        <td>
                                                                            <span style={{
                                                                                background: '#f07c00',
                                                                                color: 'white',
                                                                                padding: '4px 12px',
                                                                                borderRadius: '4px',
                                                                                fontSize: '13px',
                                                                                fontWeight: '600'
                                                                            }}>
                                                                                {branch}
                                                                            </span>
                                                                        </td>
                                                                        <td>
                                                                            <input
                                                                                type="text"
                                                                                value={formatBudgetInput(budget)}
                                                                                onChange={(e) => handleBudgetChange(branch, e.target.value)}
                                                                                style={{
                                                                                    width: '100%',
                                                                                    padding: '8px 12px',
                                                                                    borderRadius: '6px',
                                                                                    border: '2px solid #e0e0e0',
                                                                                    fontSize: '14px',
                                                                                    textAlign: 'right'
                                                                                }}
                                                                                placeholder="0"
                                                                            />
                                                                        </td>
                                                                        <td className="amount">{formatAmount(used)}</td>
                                                                        <td style={{
                                                                            color: remaining >= 0 ? '#28a745' : '#dc3545',
                                                                            fontWeight: '600'
                                                                        }}>
                                                                            {formatAmount(remaining)}
                                                                        </td>
                                                                        <td>
                                                                            <div style={{
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                gap: '8px'
                                                                            }}>
                                                                                <div style={{
                                                                                    flex: 1,
                                                                                    height: '8px',
                                                                                    background: '#e0e0e0',
                                                                                    borderRadius: '4px',
                                                                                    overflow: 'hidden'
                                                                                }}>
                                                                                    <div style={{
                                                                                        width: `${Math.min(usageRate, 100)}%`,
                                                                                        height: '100%',
                                                                                        background: usageRate > 100 ? '#dc3545' : usageRate > 80 ? '#ffc107' : '#28a745',
                                                                                        transition: 'width 0.3s ease'
                                                                                    }} />
                                                                                </div>
                                                                                <span style={{
                                                                                    fontSize: '13px',
                                                                                    fontWeight: '600',
                                                                                    color: usageRate > 100 ? '#dc3545' : '#333',
                                                                                    minWidth: '45px'
                                                                                }}>
                                                                                    {usageRate}%
                                                                                </span>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    
                                                    <div style={{marginTop: '20px', textAlign: 'right'}}>
                                                        <button 
                                                            className="btn"
                                                            onClick={handleSaveBudgets}
                                                            disabled={isSavingBudget}
                                                        >
                                                            {isSavingBudget ? '저장 중...' : '배정 비용 저장'}
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </>
                                    ) : (
                                        <div style={{
                                            textAlign: 'center',
                                            padding: '60px 20px',
                                            color: '#999'
                                        }}>
                                            <p style={{fontSize: '16px', marginBottom: '8px'}}>Round를 선택해주세요</p>
                                            <p style={{fontSize: '13px'}}>위에서 Round를 선택하면 지점별 비용을 배정할 수 있습니다.</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // 사용자 관리 페이지
        function UsersPage() {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showModal, setShowModal] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [formData, setFormData] = useState({
                email: '',
                password: '',
                displayName: '',
                branchName: ''
            });
            const [selectedUsers, setSelectedUsers] = useState([]);
            
            // 삭제 확인 모달 상태
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [deletePassword, setDeletePassword] = useState('');
            const [isDeleting, setIsDeleting] = useState(false);

            // 사용자 목록 실시간 리스너
            useEffect(() => {
                setLoading(true);
                const unsubscribe = db.collection('users').onSnapshot(
                    (snapshot) => {
                        const usersData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        // 클라이언트에서 정렬 (createdAt 기준 내림차순)
                        usersData.sort((a, b) => {
                            const dateA = a.createdAt?.toDate?.() || new Date(0);
                            const dateB = b.createdAt?.toDate?.() || new Date(0);
                            return dateB - dateA;
                        });
                        setUsers(usersData);
                        setLoading(false);
                    },
                    (error) => {
                        console.error('사용자 목록 로드 오류:', error);
                        setLoading(false);
                    }
                );

                return () => unsubscribe();
            }, []);

            // 수동 새로고침용 (삭제 후 선택 초기화 등)
            const loadUsers = async () => {
                setSelectedUsers([]); // 선택 초기화
            };

            // 체크박스 - 개별 선택
            const handleSelectUser = (uid) => {
                setSelectedUsers(prev => {
                    if (prev.includes(uid)) {
                        return prev.filter(id => id !== uid);
                    } else {
                        return [...prev, uid];
                    }
                });
            };

            // 체크박스 - 전체 선택
            const handleSelectAll = () => {
                if (selectedUsers.length === users.filter(u => u.role !== 'admin').length) {
                    setSelectedUsers([]);
                } else {
                    // 관리자는 제외하고 선택
                    setSelectedUsers(users.filter(u => u.role !== 'admin').map(u => u.uid));
                }
            };

            // 선택된 사용자 삭제 모달 열기
            const handleDeleteSelected = () => {
                if (selectedUsers.length === 0) {
                    alert('삭제할 사용자를 선택해주세요.');
                    return;
                }
                setDeletePassword('');
                setShowDeleteModal(true);
            };

            // 비밀번호 확인 후 실제 삭제 실행 (고유 비밀번호 사용)
            const confirmDelete = async () => {
                if (!deletePassword) {
                    alert('고유 비밀번호를 입력해주세요.');
                    return;
                }

                setIsDeleting(true);

                try {
                    // Firestore에서 고유 비밀번호 확인
                    const doc = await db.collection('settings').doc('roundPassword').get();
                    
                    if (!doc.exists) {
                        alert('고유 비밀번호가 설정되지 않았습니다. Firebase Console에서 설정해주세요.');
                        setIsDeleting(false);
                        return;
                    }
                    
                    const storedPassword = doc.data().password;
                    
                    if (deletePassword !== storedPassword) {
                        alert('비밀번호가 올바르지 않습니다.');
                        setIsDeleting(false);
                        return;
                    }

                    // 삭제 실행
                    let successCount = 0;
                    let failCount = 0;

                    for (const uid of selectedUsers) {
                        const result = await deleteUserFromFirestore(uid);
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    }

                    alert(`삭제 완료: ${successCount}명 성공, ${failCount}명 실패`);
                    setShowDeleteModal(false);
                    setDeletePassword('');
                    loadUsers();

                } catch (error) {
                    console.error('삭제 오류:', error);
                    alert('삭제 중 오류가 발생했습니다: ' + error.message);
                } finally {
                    setIsDeleting(false);
                }
            };

            // 모달 열기 (신규 등록)
            const openAddModal = () => {
                setEditingUser(null);
                setFormData({
                    email: '',
                    password: '',
                    displayName: '',
                    branchName: '',
                    adminPassword: ''
                });
                setShowModal(true);
            };

            // 모달 열기 (수정)
            const openEditModal = (user) => {
                setEditingUser(user);
                setFormData({
                    email: user.email,
                    password: '',
                    displayName: user.displayName || '',
                    branchName: user.branchName || '',
                    adminPassword: ''
                });
                setShowModal(true);
            };

            // 사용자 등록/수정
            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (editingUser) {
                    // 수정
                    const result = await updateUser(editingUser.uid, {
                        displayName: formData.displayName,
                        branchName: formData.branchName
                    });
                    if (result.success) {
                        alert('사용자 정보가 수정되었습니다.');
                        setShowModal(false);
                        loadUsers();
                    } else {
                        alert(result.message);
                    }
                } else {
                    // 신규 등록
                    if (!formData.email || !formData.password) {
                        alert('이메일과 비밀번호를 입력해주세요.');
                        return;
                    }
                    if (!formData.adminPassword) {
                        alert('관리자 비밀번호를 입력해주세요.');
                        return;
                    }
                    
                    // 사용자 생성 중 플래그 설정 (리다이렉트 방지)
                    isCreatingUser = true;
                    
                    // 관리자용 사용자 생성 (생성 후 관리자로 재로그인)
                    const result = await createUserByAdmin(
                        formData.email,
                        formData.password,
                        ADMIN_EMAIL,
                        formData.adminPassword,
                        formData.displayName,
                        formData.branchName
                    );
                    
                    // 플래그 해제
                    isCreatingUser = false;
                    
                    if (result.success) {
                        alert('사용자가 등록되었습니다.');
                        setShowModal(false);
                        loadUsers();
                    } else {
                        alert(result.message);
                    }
                }
            };

            // 사용자 활성화/비활성화
            const handleToggleActive = async (user) => {
                const newStatus = !user.isActive;
                const result = await toggleUserActive(user.uid, newStatus);
                if (result.success) {
                    loadUsers();
                } else {
                    alert(result.message);
                }
            };

            // 사용자 삭제
            const handleDelete = async (user) => {
                if (!confirm(`"${user.email}" 사용자를 삭제하시겠습니까?`)) return;
                
                const result = await deleteUserFromFirestore(user.uid);
                if (result.success) {
                    alert('사용자가 삭제되었습니다.');
                    loadUsers();
                } else {
                    alert(result.message);
                }
            };

            return (
                <div>
                    <div className="page-header">
                        <h2 className="page-title">사용자 관리</h2>
                        <p className="page-subtitle">등록된 사용자를 관리합니다</p>
                    </div>

                    <div className="stats-grid">
                        <div className="stat-card">
                            <h3>전체 사용자</h3>
                            <div className="value">{users.length}</div>
                        </div>
                        <div className="stat-card">
                            <h3>활성 사용자</h3>
                            <div className="value">{users.filter(u => u.isActive).length}</div>
                        </div>
                        <div className="stat-card">
                            <h3>비활성 사용자</h3>
                            <div className="value">{users.filter(u => !u.isActive).length}</div>
                        </div>
                    </div>

                    <div className="content-area">
                        <div className="page-header-actions">
                            <div style={{display: 'flex', alignItems: 'center', gap: '15px'}}>
                                <h3 className="section-title" style={{marginBottom: 0}}>사용자 목록</h3>
                                {selectedUsers.length > 0 && (
                                    <span style={{fontSize: '14px', color: '#f07c00'}}>{selectedUsers.length}명 선택됨</span>
                                )}
                            </div>
                            <div style={{display: 'flex', gap: '10px'}}>
                                {selectedUsers.length > 0 && (
                                    <button className="btn btn-danger" onClick={handleDeleteSelected}>
                                        선택 삭제 ({selectedUsers.length})
                                    </button>
                                )}
                                <button className="btn" onClick={openAddModal}>+ 사용자 추가</button>
                            </div>
                        </div>

                        {loading ? (
                            <div className="loading-spinner">사용자 목록을 불러오는 중...</div>
                        ) : users.length === 0 ? (
                            <div className="empty-state">등록된 사용자가 없습니다.</div>
                        ) : (
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th style={{width: '40px'}}>
                                            <input 
                                                type="checkbox"
                                                checked={selectedUsers.length === users.filter(u => u.role !== 'admin').length && users.filter(u => u.role !== 'admin').length > 0}
                                                onChange={handleSelectAll}
                                                style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                            />
                                        </th>
                                        <th>이메일</th>
                                        <th>이름</th>
                                        <th>지점명</th>
                                        <th>역할</th>
                                        <th>상태</th>
                                        <th>가입일</th>
                                        <th>마지막 로그인</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {users.map(user => (
                                        <tr key={user.uid} style={{background: selectedUsers.includes(user.uid) ? 'rgba(240, 124, 0, 0.1)' : 'transparent'}}>
                                            <td>
                                                {user.role !== 'admin' ? (
                                                    <input 
                                                        type="checkbox"
                                                        checked={selectedUsers.includes(user.uid)}
                                                        onChange={() => handleSelectUser(user.uid)}
                                                        style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                                    />
                                                ) : (
                                                    <span style={{color: '#999', fontSize: '12px'}}>-</span>
                                                )}
                                            </td>
                                            <td>{user.email}</td>
                                            <td>{user.displayName || '-'}</td>
                                            <td>{user.branchName || '-'}</td>
                                            <td>
                                                <span className={`status-badge ${user.role === 'admin' ? 'admin' : ''}`}>
                                                    {user.role === 'admin' ? '관리자' : '사용자'}
                                                </span>
                                            </td>
                                            <td>
                                                <span className={`status-badge ${user.isActive ? 'active' : 'inactive'}`}>
                                                    {user.isActive ? '활성' : '비활성'}
                                                </span>
                                            </td>
                                            <td>{formatDate(user.createdAt)}</td>
                                            <td>{formatDate(user.lastLoginAt)}</td>
                                            <td>
                                                <div className="actions">
                                                    <button 
                                                        className="btn btn-sm btn-secondary"
                                                        onClick={() => openEditModal(user)}
                                                    >
                                                        수정
                                                    </button>
                                                    {user.role !== 'admin' && (
                                                        <button 
                                                            className={`btn btn-sm ${user.isActive ? 'btn-danger' : 'btn-success'}`}
                                                            onClick={() => handleToggleActive(user)}
                                                        >
                                                            {user.isActive ? '비활성화' : '활성화'}
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>

                    {/* 사용자 추가/수정 모달 */}
                    {showModal && (
                        <div className="modal-overlay" onClick={() => setShowModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{editingUser ? '사용자 수정' : '사용자 추가'}</h3>
                                    <button className="modal-close" onClick={() => setShowModal(false)}>×</button>
                                </div>
                                <form onSubmit={handleSubmit}>
                                    <div className="form-group">
                                        <label>이메일</label>
                                        <input
                                            type="email"
                                            value={formData.email}
                                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                                            disabled={!!editingUser}
                                            required
                                        />
                                    </div>
                                    {!editingUser && (
                                        <div className="form-group">
                                            <label>비밀번호</label>
                                            <input
                                                type="password"
                                                value={formData.password}
                                                onChange={(e) => setFormData({...formData, password: e.target.value})}
                                                placeholder="최소 6자 이상"
                                                required
                                            />
                                        </div>
                                    )}
                                    <div className="form-group">
                                        <label>이름</label>
                                        <input
                                            type="text"
                                            value={formData.displayName}
                                            onChange={(e) => setFormData({...formData, displayName: e.target.value})}
                                            placeholder="사용자 이름"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>지점명</label>
                                        <input
                                            type="text"
                                            value={formData.branchName}
                                            onChange={(e) => setFormData({...formData, branchName: e.target.value})}
                                            placeholder="소속 지점명"
                                        />
                                    </div>
                                    {!editingUser && (
                                        <div className="form-group" style={{marginTop: '20px', paddingTop: '20px', borderTop: '1px solid #eee'}}>
                                            <label style={{color: '#f07c00'}}>관리자 비밀번호 확인</label>
                                            <input
                                                type="password"
                                                value={formData.adminPassword}
                                                onChange={(e) => setFormData({...formData, adminPassword: e.target.value})}
                                                placeholder="관리자 비밀번호를 입력하세요"
                                                required
                                            />
                                            <p style={{fontSize: '12px', color: '#666', marginTop: '5px'}}>
                                                사용자 추가 후 관리자 계정 유지를 위해 필요합니다
                                            </p>
                                        </div>
                                    )}
                                    <div className="modal-actions">
                                        <button type="button" className="btn btn-secondary" onClick={() => setShowModal(false)}>
                                            취소
                                        </button>
                                        <button type="submit" className="btn">
                                            {editingUser ? '수정' : '등록'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* 삭제 확인 모달 */}
                    {showDeleteModal && (
                        <div className="modal-overlay" onClick={() => !isDeleting && setShowDeleteModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '400px'}}>
                                <div className="modal-header">
                                    <h3 style={{color: '#dc3545'}}>⚠️ 사용자 삭제</h3>
                                    <button 
                                        className="modal-close" 
                                        onClick={() => setShowDeleteModal(false)}
                                        disabled={isDeleting}
                                    >×</button>
                                </div>
                                <div style={{marginBottom: '20px'}}>
                                    <p style={{color: '#666', marginBottom: '15px'}}>
                                        선택한 <strong style={{color: '#dc3545'}}>{selectedUsers.length}명</strong>의 사용자를 삭제합니다.
                                    </p>
                                    <div style={{
                                        background: '#f8f9fa',
                                        padding: '12px',
                                        borderRadius: '8px',
                                        maxHeight: '100px',
                                        overflowY: 'auto',
                                        fontSize: '13px',
                                        color: '#333'
                                    }}>
                                        {users
                                            .filter(u => selectedUsers.includes(u.uid))
                                            .map(u => u.email)
                                            .join(', ')}
                                    </div>
                                    <p style={{fontSize: '12px', color: '#dc3545', marginTop: '10px'}}>
                                        이 작업은 되돌릴 수 없습니다.
                                    </p>
                                </div>
                                <div className="form-group">
                                    <label style={{color: '#dc3545'}}>고유 비밀번호 확인</label>
                                    <input
                                        type="password"
                                        value={deletePassword}
                                        onChange={(e) => setDeletePassword(e.target.value)}
                                        placeholder="고유 비밀번호를 입력하세요"
                                        disabled={isDeleting}
                                        onKeyPress={(e) => e.key === 'Enter' && confirmDelete()}
                                        autoFocus
                                    />
                                </div>
                                <div className="modal-actions">
                                    <button 
                                        type="button" 
                                        className="btn btn-secondary" 
                                        onClick={() => setShowDeleteModal(false)}
                                        disabled={isDeleting}
                                    >
                                        취소
                                    </button>
                                    <button 
                                        type="button" 
                                        className="btn btn-danger" 
                                        onClick={confirmDelete}
                                        disabled={isDeleting || !deletePassword}
                                    >
                                        {isDeleting ? '삭제 중...' : '삭제 확인'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // 설정 페이지
        function SettingsPage() {
            return (
                <div>
                    <div className="page-header">
                        <h2 className="page-title">설정</h2>
                        <p className="page-subtitle">시스템 설정을 관리합니다</p>
                    </div>

                    <div className="content-area">
                        <div className="settings-section">
                            <h3 className="section-title">계정 설정</h3>
                            <div className="settings-item">
                                <div className="settings-item-info">
                                    <h4>이메일 알림</h4>
                                    <p>새로운 비용 등록 시 이메일로 알림을 받습니다</p>
                                </div>
                                <button className="btn" style={{padding: '8px 16px', fontSize: '12px'}}>설정</button>
                            </div>
                            <div className="settings-item">
                                <div className="settings-item-info">
                                    <h4>비밀번호 변경</h4>
                                    <p>계정 비밀번호를 변경합니다</p>
                                </div>
                                <button className="btn" style={{padding: '8px 16px', fontSize: '12px'}}>변경</button>
                            </div>
                        </div>

                        <div className="settings-section">
                            <h3 className="section-title">시스템 설정</h3>
                            <div className="settings-item">
                                <div className="settings-item-info">
                                    <h4>지점 관리</h4>
                                    <p>지점 추가, 수정, 삭제를 관리합니다</p>
                                </div>
                                <button className="btn" style={{padding: '8px 16px', fontSize: '12px'}}>관리</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // 사이드바 컴포넌트
        function Sidebar({ currentPage, setCurrentPage, user, onLogout, onRoundAccess }) {
            const menuItems = [
                { id: 'cost', name: '마케팅 비용', icon: Icons.Cost },
                { id: 'round', name: 'Round 관리', icon: Icons.Round },
                { id: 'users', name: '사용자 관리', icon: Icons.Users },
                { id: 'settings', name: '설정', icon: Icons.Settings }
            ];

            // 메뉴 클릭 핸들러
            const handleMenuClick = (itemId) => {
                if (itemId === 'round') {
                    onRoundAccess();
                } else {
                    setCurrentPage(itemId);
                }
            };

            return (
                <aside className="sidebar">
                    <div className="sidebar-header">
                        <div className="admin-badge">ADMIN</div>
                        <h1>관리자 페이지</h1>
                        <p>Marketing Cost Compilater</p>
                    </div>

                    <nav className="sidebar-nav">
                        {menuItems.map(item => (
                            <div
                                key={item.id}
                                className={`nav-item ${currentPage === item.id ? 'active' : ''}`}
                                onClick={() => handleMenuClick(item.id)}
                            >
                                <item.icon />
                                <span>{item.name}</span>
                            </div>
                        ))}
                    </nav>

                    <div className="sidebar-footer">
                        <div className="user-info-sidebar">
                            <div className="user-avatar">
                                {user?.email?.charAt(0).toUpperCase()}
                            </div>
                            <div className="user-details">
                                <div className="name">{user?.email}</div>
                                <div className="role">관리자</div>
                            </div>
                        </div>
                        <button className="logout-btn" onClick={onLogout}>
                            로그아웃
                        </button>
                    </div>
                </aside>
            );
        }

        // 메인 앱 컴포넌트
        function App() {
            const [currentPage, setCurrentPage] = useState('cost');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // Round 관리 접근 관련 상태
            const [showRoundPasswordModal, setShowRoundPasswordModal] = useState(false);
            const [roundPassword, setRoundPassword] = useState('');
            const [roundAccessGranted, setRoundAccessGranted] = useState(false);
            const [isVerifying, setIsVerifying] = useState(false);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    // 사용자 생성 중이면 리다이렉트만 하지 않음 (상태는 업데이트)
                    if (isCreatingUser) {
                        console.log('사용자 생성 중... 리다이렉트 스킵');
                        // 관리자 계정이면 상태만 업데이트
                        if (currentUser && currentUser.email === ADMIN_EMAIL) {
                            setUser(currentUser);
                            setLoading(false);
                        }
                        return;
                    }
                    
                    if (!currentUser) {
                        window.location.href = 'index.html';
                    } else if (currentUser.email !== ADMIN_EMAIL) {
                        window.location.href = 'user.html';
                    } else {
                        setUser(currentUser);
                        setLoading(false);
                    }
                });

                return () => unsubscribe();
            }, []);

            // Round 관리 페이지 접근 시도
            const handleRoundAccess = () => {
                if (roundAccessGranted) {
                    setCurrentPage('round');
                } else {
                    setRoundPassword('');
                    setShowRoundPasswordModal(true);
                }
            };

            // Round 비밀번호 확인 (Firestore에서 검증)
            const handleRoundPasswordSubmit = async (e) => {
                e.preventDefault();
                setIsVerifying(true);
                
                try {
                    // Firestore에서 비밀번호 가져오기
                    const doc = await db.collection('settings').doc('roundPassword').get();
                    
                    if (!doc.exists) {
                        // 비밀번호가 설정되지 않은 경우 기본값으로 생성
                        await db.collection('settings').doc('roundPassword').set({
                            password: 'round1234',
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('Round 비밀번호가 초기 설정되었습니다. 기본 비밀번호: round1234');
                        setIsVerifying(false);
                        return;
                    }
                    
                    const storedPassword = doc.data().password;
                    
                    if (roundPassword === storedPassword) {
                        setRoundAccessGranted(true);
                        setShowRoundPasswordModal(false);
                        setCurrentPage('round');
                        setRoundPassword('');
                    } else {
                        alert('비밀번호가 올바르지 않습니다.');
                        setRoundPassword('');
                    }
                } catch (error) {
                    console.error('비밀번호 확인 오류:', error);
                    alert('비밀번호 확인에 실패했습니다.');
                } finally {
                    setIsVerifying(false);
                }
            };

            const handleLogout = async () => {
                if (confirm('로그아웃 하시겠습니까?')) {
                    const result = await logout();
                    if (result.success) {
                        window.location.href = 'index.html';
                    } else {
                        alert('로그아웃 실패: ' + result.message);
                    }
                }
            };

            if (loading) {
                return <div className="loading">로딩 중...</div>;
            }

            const renderPage = () => {
                switch (currentPage) {
                    case 'cost':
                        return <MarketingCostPage />;
                    case 'round':
                        return <RoundManagementPage />;
                    case 'users':
                        return <UsersPage />;
                    case 'settings':
                        return <SettingsPage />;
                    default:
                        return <MarketingCostPage />;
                }
            };

            return (
                <div className="app-container">
                    <Sidebar
                        currentPage={currentPage}
                        setCurrentPage={setCurrentPage}
                        user={user}
                        onLogout={handleLogout}
                        onRoundAccess={handleRoundAccess}
                    />
                    <main className="main-content">
                        {renderPage()}
                    </main>

                    {/* Round 관리 비밀번호 모달 */}
                    {showRoundPasswordModal && (
                        <div className="modal-overlay" onClick={() => setShowRoundPasswordModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>🔒 Round 관리 접근</h3>
                                    <button className="modal-close" onClick={() => setShowRoundPasswordModal(false)}>×</button>
                                </div>
                                <form onSubmit={handleRoundPasswordSubmit}>
                                    <div className="modal-body">
                                        <p style={{marginBottom: '15px', color: '#666'}}>
                                            Round 관리에 접근하려면 고유 비밀번호를 입력하세요.
                                        </p>
                                        <div className="form-group">
                                            <label>비밀번호</label>
                                            <input 
                                                type="password"
                                                value={roundPassword}
                                                onChange={(e) => setRoundPassword(e.target.value)}
                                                placeholder="고유 비밀번호를 입력하세요"
                                                required
                                                autoFocus
                                            />
                                        </div>
                                    </div>
                                    <div className="modal-actions" style={{padding: '15px 20px', borderTop: '1px solid #eee', display: 'flex', gap: '10px', justifyContent: 'flex-end'}}>
                                        <button 
                                            type="button" 
                                            className="btn btn-secondary btn-sm"
                                            onClick={() => setShowRoundPasswordModal(false)}
                                            disabled={isVerifying}
                                        >
                                            취소
                                        </button>
                                        <button 
                                            type="submit" 
                                            className="btn btn-sm"
                                            disabled={isVerifying}
                                        >
                                            {isVerifying ? '확인 중...' : '확인'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // React 렌더링
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
