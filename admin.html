<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ - Marketing Cost Compilater</title>
    <link rel="icon" type="image/png" href="image/symbol_white.png">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* ÏÇ¨Ïù¥ÎìúÎ∞î - Í¥ÄÎ¶¨ÏûêÏö© Îã§ÌÅ¨ ÌÖåÎßà */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-badge {
            display: inline-block;
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 12px;
            text-transform: uppercase;
            box-shadow: 0 2px 10px rgba(233, 69, 96, 0.4);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.7;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            gap: 12px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
            border-left-color: #e94560;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .nav-item span {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info-sidebar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: #e94560;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-details .name {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-details .role {
            font-size: 11px;
            opacity: 0.7;
        }

        .logout-btn {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #e94560;
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            color: #1a1a2e;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #666;
            font-size: 14px;
        }

        .content-area {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(26, 26, 46, 0.3);
        }

        .stat-card h3 {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
        }

        .btn {
            background: #e94560;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #d63850;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .section-title {
            color: #1a1a2e;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* ÌÖåÏù¥Î∏î Ïä§ÌÉÄÏùº */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-size: 13px;
            font-weight: 600;
            color: #1a1a2e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            font-size: 14px;
            color: #333;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table .actions {
            display: flex;
            gap: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.admin {
            background: #ffe0e6;
            color: #e94560;
        }

        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #001236;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ Î≤ÑÌäº */
        .btn-preview {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            color: #004085;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-preview:hover {
            background: #cce5ff;
            border-color: #99caff;
        }

        /* Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îã¨ */
        .image-modal {
            background: rgba(0, 0, 0, 0.95);
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .image-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .image-modal-header h3 {
            font-size: 16px;
            font-weight: 500;
        }

        .image-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
        }

        .image-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .image-modal-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            min-height: 400px;
        }

        .image-modal-body img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .image-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
        }

        .image-nav-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .image-nav-btn.prev {
            left: 20px;
        }

        .image-nav-btn.next {
            right: 20px;
        }

        .image-modal-footer {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
        }

        .image-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: background 0.2s;
        }

        .image-dot.active {
            background: #f07c00;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #e94560;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Ìó§Îçî Ïï°ÏÖò */
        .page-header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* ÏÑ†ÌÉùÎêú Ìñâ */
        .data-table tbody tr.selected {
            background: #ffe0e6;
        }

        /* Ïï°ÏÖò Î∞î */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .action-bar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .action-bar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-bar span {
            font-size: 14px;
            color: #666;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        /* ÌÉ≠ Ïä§ÌÉÄÏùº */
        .tab-container {
            margin-bottom: 24px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 24px;
        }

        .tab-button {
            padding: 14px 24px;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: #1a1a2e;
        }

        .tab-button.active {
            color: #e94560;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #e94560;
            border-radius: 2px 2px 0 0;
        }

        .tab-content {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Round Í¥ÄÎ¶¨ Ïä§ÌÉÄÏùº */
        .round-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .round-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .round-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #001236;
        }

        .round-date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .branch-cost-table {
            width: 100%;
            border-collapse: collapse;
        }

        .branch-cost-table th,
        .branch-cost-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .branch-cost-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #001236;
        }

        .branch-cost-table .amount {
            font-weight: 600;
            color: #001236;
        }

        /* ÏÑ§Ï†ï ÌéòÏù¥ÏßÄ Ïä§ÌÉÄÏùº */
        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }

        .settings-item-info h4 {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }

        .settings-item-info p {
            font-size: 12px;
            color: #666;
        }

        /* Î°úÎî© */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 16px;
            color: #666;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar-header h1,
            .sidebar-header p,
            .nav-item span,
            .user-details,
            .logout-btn span {
                display: none;
            }

            .nav-item {
                justify-content: center;
                padding: 14px;
            }

            .main-content {
                margin-left: 70px;
                padding: 20px;
            }

            .user-info-sidebar {
                justify-content: center;
            }

            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">Î°úÎî© Ï§ë...</div>
    </div>

    <!-- Firebase ÏÑ§Ï†ï -->
    <script src="firebase.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const ADMIN_EMAIL = 'admin@dshare.co.kr';
        
        // ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± Ï§ë ÌîåÎûòÍ∑∏ (Ï†ÑÏó≠ - onAuthStateChanged ÏΩúÎ∞±ÏóêÏÑú Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎèÑÎ°ù)
        let isCreatingUser = false;

        // ÏïÑÏù¥ÏΩò Ïª¥Ìè¨ÎÑåÌä∏
        const Icons = {
            Cost: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
            ),
            Round: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            ),
            Users: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            ),
            Settings: () => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            )
        };

        // ÎÇ†Ïßú Ìè¨Îß∑
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥
        const categories = {
            online: { label: 'Ïò®ÎùºÏù∏ Í¥ëÍ≥†', className: 'online' },
            offline: { label: 'Ïò§ÌîÑÎùºÏù∏ Í¥ëÍ≥†', className: 'offline' },
            event: { label: 'Ïù¥Î≤§Ìä∏/ÌîÑÎ°úÎ™®ÏÖò', className: 'event' },
            material: { label: 'ÌôçÎ≥¥Î¨º Ï†úÏûë', className: 'material' },
            other: { label: 'Í∏∞ÌÉÄ', className: 'other' }
        };

        // ÎßàÏºÄÌåÖ ÎπÑÏö© ÌéòÏù¥ÏßÄ
        function MarketingCostPage() {
            const [costs, setCosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [branches, setBranches] = useState([]);
            const [selectedBranch, setSelectedBranch] = useState('all');
            
            // ÎÇ†Ïßú ÌïÑÌÑ∞ ÏÉÅÌÉú
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            
            // ÏÑ†ÌÉù Î∞è ÏÇ≠Ï†ú Í¥ÄÎ†® ÏÉÅÌÉú
            const [selectedCosts, setSelectedCosts] = useState([]);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [deletePassword, setDeletePassword] = useState('');
            const [isDeleting, setIsDeleting] = useState(false);
            
            // Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îã¨ ÏÉÅÌÉú
            const [showImageModal, setShowImageModal] = useState(false);
            const [previewImages, setPreviewImages] = useState([]);
            const [currentImageIndex, setCurrentImageIndex] = useState(0);
            
            // Round Í¥ÄÎ†® ÏÉÅÌÉú
            const [currentRound, setCurrentRound] = useState(null);
            const [totalBudget, setTotalBudget] = useState(0);
            const [branchBudgets, setBranchBudgets] = useState({});

            // Í∏àÏï° Ìè¨Îß∑
            const formatAmount = (amount) => {
                return new Intl.NumberFormat('ko-KR', {
                    style: 'currency',
                    currency: 'KRW'
                }).format(amount);
            };

            // Í∏àÏï° Ìè¨Îß∑ (ÏóëÏÖÄÏö© - Ïà´ÏûêÎßå)
            const formatAmountForExcel = (amount) => {
                return Number(amount || 0);
            };

            // ÎÇ†Ïßú Ìè¨Îß∑ (ÎπÑÏö©Ïö©)
            const formatCostDate = (dateValue) => {
                if (!dateValue) return '-';
                const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };

            // ÎÇ†Ïßú Ìè¨Îß∑ (ÏóëÏÖÄÏö©)
            const formatDateForExcel = (dateValue) => {
                if (!dateValue) return '';
                const date = dateValue.toDate ? dateValue.toDate() : new Date(dateValue);
                return date.toLocaleDateString('ko-KR');
            };

            // FirestoreÏóêÏÑú Î™®Îì† ÎπÑÏö© Î°úÎìú
            useEffect(() => {
                const unsubscribe = db.collection('costs')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const costsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setCosts(costsData);
                        
                        // ÏßÄÏ†ê Î™©Î°ù Ï∂îÏ∂ú
                        const branchSet = new Set();
                        costsData.forEach(cost => {
                            if (cost.branchName) {
                                branchSet.add(cost.branchName);
                            }
                        });
                        setBranches([...branchSet].sort());
                        setLoading(false);
                    }, (error) => {
                        console.error('ÎπÑÏö© Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                        setLoading(false);
                    });

                return () => unsubscribe();
            }, []);

            // ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ RoundÏôÄ Î∞∞Ï†ï ÎπÑÏö© Î°úÎìú
            useEffect(() => {
                const today = new Date().toISOString().split('T')[0];

                const roundsUnsubscribe = db.collection('rounds')
                    .onSnapshot(async (snapshot) => {
                        const roundsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));

                        // ÌòÑÏû¨ ÎÇ†ÏßúÍ∞Ä Ìè¨Ìï®Îêú Round Ï∞æÍ∏∞
                        const activeRound = roundsData.find(round => {
                            return today >= round.startDate && today <= round.endDate;
                        });

                        if (activeRound) {
                            setCurrentRound(activeRound);

                            // Ìï¥Îãπ RoundÏùò Ï†ÑÏ≤¥ Î∞∞Ï†ï ÎπÑÏö© Í∞ÄÏ†∏Ïò§Í∏∞
                            try {
                                const budgetDoc = await db.collection('roundBudgets').doc(activeRound.id).get();
                                if (budgetDoc.exists) {
                                    const budgets = budgetDoc.data().budgets || {};
                                    setBranchBudgets(budgets);
                                    // Ï†ÑÏ≤¥ Î∞∞Ï†ï ÎπÑÏö© Ìï©Í≥Ñ
                                    const total = Object.values(budgets).reduce((sum, val) => sum + Number(val || 0), 0);
                                    setTotalBudget(total);
                                }
                            } catch (error) {
                                console.error('Î∞∞Ï†ï ÎπÑÏö© Î°úÎìú Ïò§Î•ò:', error);
                            }
                        } else {
                            setCurrentRound(null);
                            setTotalBudget(0);
                            setBranchBudgets({});
                        }
                    });

                return () => roundsUnsubscribe();
            }, []);

            // Round Í∏∞Í∞Ñ ÎÇ¥ ÏÇ¨Ïö© ÎπÑÏö© Í≥ÑÏÇ∞ (Ï†ÑÏ≤¥)
            const getRoundUsedAmount = () => {
                if (!currentRound) return 0;
                
                return costs.filter(cost => {
                    const costDate = cost.date;
                    return costDate >= currentRound.startDate && costDate <= currentRound.endDate;
                }).reduce((sum, cost) => sum + Number(cost.amount || 0), 0);
            };

            // Round Í∏∞Í∞Ñ ÎÇ¥ ÏßÄÏ†êÎ≥Ñ ÏÇ¨Ïö© ÎπÑÏö© Í≥ÑÏÇ∞
            const getRoundUsedByBranch = (branchName) => {
                if (!currentRound) return 0;
                
                return costs.filter(cost => {
                    if (cost.branchName !== branchName) return false;
                    const costDate = cost.date;
                    return costDate >= currentRound.startDate && costDate <= currentRound.endDate;
                }).reduce((sum, cost) => sum + Number(cost.amount || 0), 0);
            };

            // ÌïÑÌÑ∞ÎßÅÎêú ÎπÑÏö©
            // ÌïÑÌÑ∞ÎßÅÎêú ÎπÑÏö© Î™©Î°ù
            const filteredCosts = costs.filter(cost => {
                // ÏßÄÏ†ê ÌïÑÌÑ∞
                if (selectedBranch !== 'all' && cost.branchName !== selectedBranch) {
                    return false;
                }
                
                // ÎÇ†Ïßú ÌïÑÌÑ∞ (cost.date Í∏∞Ï§Ä)
                if (startDate || endDate) {
                    const costDate = new Date(cost.date);
                    
                    if (startDate) {
                        const start = new Date(startDate);
                        start.setHours(0, 0, 0, 0);
                        if (costDate < start) return false;
                    }
                    
                    if (endDate) {
                        const end = new Date(endDate);
                        end.setHours(23, 59, 59, 999);
                        if (costDate > end) return false;
                    }
                }
                
                return true;
            });
            
            // ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
            const handleResetFilters = () => {
                setSelectedBranch('all');
                setStartDate('');
                setEndDate('');
            };

            // Ï≤¥ÌÅ¨Î∞ïÏä§ - Í∞úÎ≥Ñ ÏÑ†ÌÉù
            const handleSelectCost = (id) => {
                setSelectedCosts(prev => {
                    if (prev.includes(id)) {
                        return prev.filter(costId => costId !== id);
                    } else {
                        return [...prev, id];
                    }
                });
            };

            // Ï≤¥ÌÅ¨Î∞ïÏä§ - Ï†ÑÏ≤¥ ÏÑ†ÌÉù
            const handleSelectAll = () => {
                if (selectedCosts.length === filteredCosts.length) {
                    setSelectedCosts([]);
                } else {
                    setSelectedCosts(filteredCosts.map(cost => cost.id));
                }
            };

            // ÏÇ≠Ï†ú Î™®Îã¨ Ïó¥Í∏∞
            const openDeleteModal = () => {
                if (selectedCosts.length === 0) {
                    alert('ÏÇ≠Ï†úÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                setDeletePassword('');
                setShowDeleteModal(true);
            };

            // Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ Ïó¥Í∏∞
            const openImagePreview = (images) => {
                if (!images || images.length === 0) {
                    alert('Îì±Î°ùÎêú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                setPreviewImages(images);
                setCurrentImageIndex(0);
                setShowImageModal(true);
            };

            // Ïù¥Ï†Ñ/Îã§Ïùå Ïù¥ÎØ∏ÏßÄ
            const handlePrevImage = () => {
                setCurrentImageIndex(prev => prev > 0 ? prev - 1 : previewImages.length - 1);
            };

            const handleNextImage = () => {
                setCurrentImageIndex(prev => prev < previewImages.length - 1 ? prev + 1 : 0);
            };

            // ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ ÌõÑ ÏÇ≠Ï†ú Ïã§Ìñâ
            const handleConfirmDelete = async (e) => {
                e.preventDefault();
                
                if (!deletePassword) {
                    alert('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                setIsDeleting(true);

                try {
                    // Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ (Ïû¨Ïù∏Ï¶ù)
                    const adminUser = auth.currentUser;
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        adminUser.email,
                        deletePassword
                    );
                    await adminUser.reauthenticateWithCredential(credential);

                    // ÏÑ†ÌÉùÎêú ÎπÑÏö©Ïùò Ïù¥ÎØ∏ÏßÄÎèÑ Ìï®Íªò ÏÇ≠Ï†ú
                    for (const costId of selectedCosts) {
                        const costData = costs.find(c => c.id === costId);
                        if (costData && costData.userId) {
                            await deleteCostImages(costData.userId, costId);
                        }
                    }

                    // FirestoreÏóêÏÑú ÎπÑÏö© Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                    const batch = db.batch();
                    selectedCosts.forEach(id => {
                        const docRef = db.collection('costs').doc(id);
                        batch.delete(docRef);
                    });
                    await batch.commit();

                    alert(`${selectedCosts.length}Í∞ú Ìï≠Î™©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
                    setSelectedCosts([]);
                    setShowDeleteModal(false);
                } catch (error) {
                    console.error('ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                    if (error.code === 'auth/wrong-password') {
                        alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
                    } else {
                        alert('ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
                    }
                } finally {
                    setIsDeleting(false);
                    setDeletePassword('');
                }
            };

            // ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
            const handleExportExcel = () => {
                const dataToExport = selectedCosts.length > 0 
                    ? filteredCosts.filter(cost => selectedCosts.includes(cost.id))
                    : filteredCosts;

                if (dataToExport.length === 0) {
                    alert('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                // CSV Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                const headers = ['ÏßÄÏ†ê', 'ÎÇ†Ïßú', 'Ìï≠Î™©', 'Í∏àÏï°', 'ÏÑ§Î™Ö', 'Îì±Î°ùÏûê', 'Îì±Î°ùÏùºÏãú'];
                const rows = dataToExport.map(cost => [
                    cost.branchName || 'ÎØ∏ÏÑ§Ï†ï',
                    formatDateForExcel(cost.date),
                    categories[cost.category]?.label || cost.category,
                    formatAmountForExcel(cost.amount),
                    cost.description || '',
                    cost.userEmail || '',
                    formatDateForExcel(cost.createdAt)
                ]);

                // BOM Ï∂îÍ∞Ä (ÌïúÍ∏Ä Íπ®Ïßê Î∞©ÏßÄ)
                const BOM = '\uFEFF';
                const csvContent = BOM + [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                ].join('\n');

                // ÌååÏùº Îã§Ïö¥Î°úÎìú
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                const fileName = `ÎßàÏºÄÌåÖÎπÑÏö©_${selectedBranch === 'all' ? 'Ï†ÑÏ≤¥' : selectedBranch}_${new Date().toLocaleDateString('ko-KR').replace(/\./g, '')}.csv`;
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Ïù¥Î≤à Îã¨ ÎπÑÏö© Í≥ÑÏÇ∞
            const getMonthlyTotal = () => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                return filteredCosts
                    .filter(cost => {
                        const costDate = cost.date ? new Date(cost.date) : null;
                        return costDate && costDate.getMonth() === currentMonth && costDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, cost) => sum + Number(cost.amount || 0), 0);
            };

            // Ï¥ù ÎπÑÏö© Í≥ÑÏÇ∞
            const getTotalAmount = () => {
                return filteredCosts.reduce((sum, cost) => sum + Number(cost.amount || 0), 0);
            };

            if (loading) {
                return (
                    <div className="loading-spinner">
                        <p>ÎπÑÏö© Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                    </div>
                );
            }

            return (
                <div>
                    <div className="page-header">
                        <h2 className="page-title">ÎßàÏºÄÌåÖ ÎπÑÏö©</h2>
                        <p className="page-subtitle">Ï†ÑÏ≤¥ ÏßÄÏ†êÏùò ÎßàÏºÄÌåÖ ÎπÑÏö©ÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§</p>
                    </div>

                    {/* ÌòÑÏû¨ Round Ï†ïÎ≥¥ Ïπ¥Îìú - Ï†ÑÏ≤¥ ÎòêÎäî ÏÑ†ÌÉùÎêú ÏßÄÏ†ê */}
                    {currentRound && totalBudget > 0 && (
                        <div style={{
                            background: selectedBranch !== 'all' 
                                ? 'linear-gradient(135deg, #0d4f3c 0%, #1a6b4f 100%)' 
                                : 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
                            borderRadius: '12px',
                            padding: '24px',
                            marginBottom: '20px',
                            color: 'white'
                        }}>
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginBottom: '16px'
                            }}>
                                <div>
                                    <div style={{display: 'flex', gap: '8px', alignItems: 'center', marginBottom: '8px'}}>
                                        <div style={{
                                            display: 'inline-block',
                                            background: '#e94560',
                                            padding: '4px 10px',
                                            borderRadius: '4px',
                                            fontSize: '11px',
                                            fontWeight: '700'
                                        }}>
                                            ÌòÑÏû¨ ÏßÑÌñâÏ§ë
                                        </div>
                                        {selectedBranch !== 'all' && (
                                            <div style={{
                                                display: 'inline-block',
                                                background: '#f07c00',
                                                padding: '4px 12px',
                                                borderRadius: '4px',
                                                fontSize: '12px',
                                                fontWeight: '700'
                                            }}>
                                                üìç {selectedBranch}
                                            </div>
                                        )}
                                    </div>
                                    <h3 style={{fontSize: '18px', fontWeight: '700', marginBottom: '4px'}}>
                                        {currentRound.name}
                                    </h3>
                                    <p style={{fontSize: '13px', opacity: 0.7}}>
                                        {currentRound.startDate} ~ {currentRound.endDate}
                                    </p>
                                </div>
                                {(() => {
                                    const displayBudget = selectedBranch !== 'all' 
                                        ? (branchBudgets[selectedBranch] || 0)
                                        : totalBudget;
                                    const displayUsed = selectedBranch !== 'all'
                                        ? getRoundUsedByBranch(selectedBranch)
                                        : getRoundUsedAmount();
                                    const rate = displayBudget > 0 ? Math.round((displayUsed / displayBudget) * 100) : 0;
                                    return (
                                        <div style={{
                                            background: rate > 100 ? '#dc3545' : rate > 80 ? '#fbbf24' : '#e94560',
                                            padding: '8px 16px',
                                            borderRadius: '20px',
                                            fontSize: '14px',
                                            fontWeight: '700'
                                        }}>
                                            {rate}% ÏÜåÏßÑ
                                        </div>
                                    );
                                })()}
                            </div>
                            
                            {/* ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î */}
                            {(() => {
                                const displayBudget = selectedBranch !== 'all' 
                                    ? (branchBudgets[selectedBranch] || 0)
                                    : totalBudget;
                                const displayUsed = selectedBranch !== 'all'
                                    ? getRoundUsedByBranch(selectedBranch)
                                    : getRoundUsedAmount();
                                const rate = displayBudget > 0 ? (displayUsed / displayBudget) * 100 : 0;
                                return (
                                    <div style={{
                                        background: 'rgba(255,255,255,0.2)',
                                        borderRadius: '10px',
                                        height: '14px',
                                        marginBottom: '20px',
                                        overflow: 'hidden'
                                    }}>
                                        <div style={{
                                            width: `${Math.min(rate, 100)}%`,
                                            height: '100%',
                                            background: rate > 100 
                                                ? 'linear-gradient(90deg, #dc3545, #ff6b6b)' 
                                                : rate > 80
                                                ? 'linear-gradient(90deg, #fbbf24, #fcd34d)'
                                                : 'linear-gradient(90deg, #e94560, #ff6b6b)',
                                            transition: 'width 0.5s ease'
                                        }} />
                                    </div>
                                );
                            })()}
                            
                            {/* ÏßÄÏ†ê ÏÑ†ÌÉù Ïãú Ìï¥Îãπ ÏßÄÏ†ê Ï†ïÎ≥¥ ÌëúÏãú */}
                            {selectedBranch !== 'all' ? (
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '16px'}}>
                                    <div>
                                        <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>Î∞∞Ï†ï ÏòàÏÇ∞</div>
                                        <div style={{fontSize: '22px', fontWeight: '700'}}>
                                            {formatAmount(branchBudgets[selectedBranch] || 0)}
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>ÏÇ¨Ïö© ÎπÑÏö©</div>
                                        <div style={{fontSize: '22px', fontWeight: '700'}}>
                                            {formatAmount(getRoundUsedByBranch(selectedBranch))}
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>ÏûîÏó¨ ÏòàÏÇ∞</div>
                                        <div style={{
                                            fontSize: '22px', 
                                            fontWeight: '700',
                                            color: (branchBudgets[selectedBranch] || 0) - getRoundUsedByBranch(selectedBranch) < 0 ? '#ff6b6b' : '#4ade80'
                                        }}>
                                            {formatAmount((branchBudgets[selectedBranch] || 0) - getRoundUsedByBranch(selectedBranch))}
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>Round Îì±Î°ù Í±¥Ïàò</div>
                                        <div style={{fontSize: '22px', fontWeight: '700'}}>
                                            {costs.filter(cost => {
                                                if (cost.branchName !== selectedBranch) return false;
                                                const costDate = cost.date;
                                                return costDate >= currentRound.startDate && costDate <= currentRound.endDate;
                                            }).length}Í±¥
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '16px'}}>
                                        <div>
                                            <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>Ï¥ù Î∞∞Ï†ï ÏòàÏÇ∞</div>
                                            <div style={{fontSize: '22px', fontWeight: '700'}}>{formatAmount(totalBudget)}</div>
                                        </div>
                                        <div>
                                            <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>Ï¥ù ÏÇ¨Ïö© ÎπÑÏö©</div>
                                            <div style={{fontSize: '22px', fontWeight: '700'}}>{formatAmount(getRoundUsedAmount())}</div>
                                        </div>
                                        <div>
                                            <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>ÏûîÏó¨ ÏòàÏÇ∞</div>
                                            <div style={{
                                                fontSize: '22px', 
                                                fontWeight: '700',
                                                color: totalBudget - getRoundUsedAmount() < 0 ? '#ff6b6b' : '#4ade80'
                                            }}>
                                                {formatAmount(totalBudget - getRoundUsedAmount())}
                                            </div>
                                        </div>
                                        <div>
                                            <div style={{fontSize: '12px', opacity: 0.8, marginBottom: '4px'}}>Î∞∞Ï†ï ÏßÄÏ†ê Ïàò</div>
                                            <div style={{fontSize: '22px', fontWeight: '700'}}>
                                                {Object.keys(branchBudgets).filter(k => branchBudgets[k] > 0).length}Í∞ú
                                            </div>
                                        </div>
                                    </div>

                                    {/* ÏßÄÏ†êÎ≥Ñ ÏÜåÏßÑÏú® ÎØ∏Îãà ÌÖåÏù¥Î∏î (Ï†ÑÏ≤¥ ÏÑ†ÌÉù ÏãúÏóêÎßå ÌëúÏãú) */}
                                    {Object.keys(branchBudgets).length > 0 && (
                                        <div style={{
                                            marginTop: '20px',
                                            paddingTop: '20px',
                                            borderTop: '1px solid rgba(255,255,255,0.1)'
                                        }}>
                                            <div style={{fontSize: '13px', fontWeight: '600', marginBottom: '12px', opacity: 0.9}}>
                                                ÏßÄÏ†êÎ≥Ñ ÏÜåÏßÑÏú®
                                            </div>
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '10px'}}>
                                                {Object.entries(branchBudgets)
                                                    .filter(([_, budget]) => budget > 0)
                                                    .map(([branch, budget]) => {
                                                        const used = getRoundUsedByBranch(branch);
                                                        const rate = budget > 0 ? Math.round((used / budget) * 100) : 0;
                                                        return (
                                                            <div 
                                                                key={branch} 
                                                                style={{
                                                                    background: 'rgba(255,255,255,0.1)',
                                                                    borderRadius: '8px',
                                                                    padding: '10px 12px',
                                                                    cursor: 'pointer',
                                                                    transition: 'all 0.2s ease'
                                                                }}
                                                                onClick={() => {
                                                                    setSelectedBranch(branch);
                                                                    setSelectedCosts([]);
                                                                }}
                                                                onMouseOver={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                                                                onMouseOut={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.1)'}
                                                            >
                                                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px'}}>
                                                                    <span style={{fontSize: '13px', fontWeight: '600'}}>{branch}</span>
                                                                    <span style={{
                                                                        fontSize: '12px',
                                                                        fontWeight: '700',
                                                                        color: rate > 100 ? '#ff6b6b' : rate > 80 ? '#fbbf24' : '#4ade80'
                                                                    }}>{rate}%</span>
                                                                </div>
                                                                <div style={{
                                                                    background: 'rgba(255,255,255,0.2)',
                                                                    borderRadius: '4px',
                                                                    height: '6px',
                                                                    overflow: 'hidden'
                                                                }}>
                                                                    <div style={{
                                                                        width: `${Math.min(rate, 100)}%`,
                                                                        height: '100%',
                                                                        background: rate > 100 ? '#dc3545' : rate > 80 ? '#fbbf24' : '#4ade80',
                                                                        transition: 'width 0.3s'
                                                                    }} />
                                                                </div>
                                                                <div style={{fontSize: '11px', opacity: 0.7, marginTop: '4px'}}>
                                                                    {formatAmount(used)} / {formatAmount(budget)}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}

                    <div className="stats-grid">
                        <div className="stat-card">
                            <h3>Ï†ÑÏ≤¥ ÏßÄÏ†ê Ïàò</h3>
                            <div className="value">{branches.length}</div>
                        </div>
                        <div className="stat-card">
                            <h3>Ïù¥Î≤à Îã¨ Ï¥ù ÎπÑÏö©</h3>
                            <div className="value">{formatAmount(getMonthlyTotal())}</div>
                        </div>
                        <div className="stat-card">
                            <h3>ÎàÑÏ†Å Ï¥ù ÎπÑÏö©</h3>
                            <div className="value">{formatAmount(getTotalAmount())}</div>
                        </div>
                    </div>

                    <div className="content-area">
                        <div className="page-header-actions">
                            <h3 className="section-title" style={{marginBottom: 0}}>ÎπÑÏö© ÌòÑÌô©</h3>
                        </div>
                        
                        {/* ÌïÑÌÑ∞ ÏòÅÏó≠ */}
                        <div style={{
                            display: 'flex', 
                            gap: '20px', 
                            alignItems: 'center',
                            flexWrap: 'wrap',
                            padding: '15px 20px',
                            background: '#f8f9fa',
                            borderRadius: '10px',
                            marginBottom: '20px'
                        }}>
                            {/* ÏßÄÏ†ê ÌïÑÌÑ∞ */}
                            <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                                <label style={{fontSize: '14px', color: '#666', fontWeight: '500'}}>ÏßÄÏ†ê:</label>
                                <select 
                                    value={selectedBranch}
                                    onChange={(e) => {
                                        setSelectedBranch(e.target.value);
                                        setSelectedCosts([]);
                                    }}
                                    style={{
                                        padding: '8px 12px',
                                        borderRadius: '6px',
                                        border: '2px solid #e0e0e0',
                                        fontSize: '14px',
                                        minWidth: '150px'
                                    }}
                                >
                                    <option value="all">Ï†ÑÏ≤¥ ÏßÄÏ†ê</option>
                                    {branches.map(branch => (
                                        <option key={branch} value={branch}>{branch}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* ÎÇ†Ïßú ÌïÑÌÑ∞ */}
                            <div style={{display: 'flex', gap: '8px', alignItems: 'center'}}>
                                <label style={{fontSize: '14px', color: '#666', fontWeight: '500'}}>Îì±Î°ù ÏùºÏãú:</label>
                                <input 
                                    type="date"
                                    value={startDate}
                                    onChange={(e) => {
                                        setStartDate(e.target.value);
                                        setSelectedCosts([]);
                                    }}
                                    style={{
                                        padding: '8px 12px',
                                        borderRadius: '6px',
                                        border: '2px solid #e0e0e0',
                                        fontSize: '14px'
                                    }}
                                />
                                <span style={{color: '#999'}}>~</span>
                                <input 
                                    type="date"
                                    value={endDate}
                                    onChange={(e) => {
                                        setEndDate(e.target.value);
                                        setSelectedCosts([]);
                                    }}
                                    style={{
                                        padding: '8px 12px',
                                        borderRadius: '6px',
                                        border: '2px solid #e0e0e0',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            {/* ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî Î≤ÑÌäº */}
                            {(selectedBranch !== 'all' || startDate || endDate) && (
                                <button
                                    onClick={handleResetFilters}
                                    style={{
                                        padding: '8px 16px',
                                        borderRadius: '6px',
                                        border: 'none',
                                        background: '#6c757d',
                                        color: 'white',
                                        fontSize: '13px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
                                </button>
                            )}
                            
                            {/* ÌïÑÌÑ∞ Í≤∞Í≥º Î∞è ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú */}
                            <div style={{marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: '15px'}}>
                                <span style={{fontSize: '14px', color: '#666'}}>
                                    Ï¥ù <strong style={{color: '#001236'}}>{filteredCosts.length}</strong>Í±¥
                                </span>
                                <button 
                                    className="btn btn-sm btn-success" 
                                    onClick={handleExportExcel}
                                    style={{whiteSpace: 'nowrap'}}
                                >
                                    {selectedCosts.length > 0 ? `ÏÑ†ÌÉù ${selectedCosts.length}Í±¥ ÏóëÏÖÄ` : 'Ï†ÑÏ≤¥ ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú'}
                                </button>
                            </div>
                        </div>

                        {filteredCosts.length === 0 ? (
                            <div className="empty-state">
                                <p>Îì±Î°ùÎêú ÎßàÏºÄÌåÖ ÎπÑÏö© Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            </div>
                        ) : (
                            <>
                                {/* ÏÑ†ÌÉù Ïãú Ïï°ÏÖò Î∞î */}
                                {selectedCosts.length > 0 && (
                                    <div className="action-bar">
                                        <div className="action-bar-left">
                                            <span>{selectedCosts.length}Í∞ú ÏÑ†ÌÉùÎê®</span>
                                        </div>
                                        <div className="action-bar-right">
                                            <button className="btn btn-sm btn-danger" onClick={openDeleteModal}>
                                                ÏÑ†ÌÉù ÏÇ≠Ï†ú
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th style={{width: '50px'}}>
                                                <input 
                                                    type="checkbox"
                                                    checked={selectedCosts.length === filteredCosts.length && filteredCosts.length > 0}
                                                    onChange={handleSelectAll}
                                                    style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                                />
                                            </th>
                                            <th>ÏßÄÏ†ê</th>
                                            <th>ÎÇ†Ïßú</th>
                                            <th>Ìï≠Î™©</th>
                                            <th>Í∏àÏï°</th>
                                            <th>ÏÑ§Î™Ö</th>
                                            <th>Îì±Î°ùÏûê</th>
                                            <th>Îì±Î°ùÏùºÏãú</th>
                                            <th style={{width: '80px'}}>Ï¶ùÎπô</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredCosts.map(cost => (
                                            <tr key={cost.id} className={selectedCosts.includes(cost.id) ? 'selected' : ''}>
                                                <td>
                                                    <input 
                                                        type="checkbox"
                                                        checked={selectedCosts.includes(cost.id)}
                                                        onChange={() => handleSelectCost(cost.id)}
                                                        style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                                    />
                                                </td>
                                                <td>
                                                    <span style={{
                                                        background: '#f07c00',
                                                        color: 'white',
                                                        padding: '4px 10px',
                                                        borderRadius: '4px',
                                                        fontSize: '12px',
                                                        fontWeight: '600'
                                                    }}>
                                                        {cost.branchName || 'ÎØ∏ÏÑ§Ï†ï'}
                                                    </span>
                                                </td>
                                                <td>{formatCostDate(cost.date)}</td>
                                                <td>
                                                    <span className={`status-badge ${categories[cost.category]?.className || ''}`} style={{
                                                        background: cost.category === 'online' ? '#e3f2fd' :
                                                                   cost.category === 'offline' ? '#f3e5f5' :
                                                                   cost.category === 'event' ? '#fff3e0' :
                                                                   cost.category === 'material' ? '#e8f5e9' : '#eceff1',
                                                        color: cost.category === 'online' ? '#1976d2' :
                                                               cost.category === 'offline' ? '#7b1fa2' :
                                                               cost.category === 'event' ? '#f57c00' :
                                                               cost.category === 'material' ? '#388e3c' : '#546e7a'
                                                    }}>
                                                        {categories[cost.category]?.label || cost.category}
                                                    </span>
                                                </td>
                                                <td style={{fontWeight: '600', color: '#001236'}}>
                                                    {formatAmount(cost.amount)}
                                                </td>
                                                <td>{cost.description || '-'}</td>
                                                <td style={{fontSize: '12px', color: '#666'}}>
                                                    {cost.userEmail}
                                                </td>
                                                <td style={{fontSize: '12px', color: '#666'}}>
                                                    {formatDate(cost.createdAt)}
                                                </td>
                                                <td>
                                                    {cost.images && cost.images.length > 0 ? (
                                                        <button 
                                                            className="btn-preview"
                                                            onClick={() => openImagePreview(cost.images)}
                                                        >
                                                            üì∑ {cost.images.length}
                                                        </button>
                                                    ) : (
                                                        <span style={{color: '#999', fontSize: '12px'}}>-</span>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </>
                        )}
                    </div>

                    {/* ÏÇ≠Ï†ú ÌôïÏù∏ Î™®Îã¨ */}
                    {showDeleteModal && (
                        <div className="modal-overlay" onClick={() => setShowDeleteModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>ÏÇ≠Ï†ú ÌôïÏù∏</h3>
                                    <button className="modal-close" onClick={() => setShowDeleteModal(false)}>√ó</button>
                                </div>
                                <form onSubmit={handleConfirmDelete}>
                                    <div className="modal-body">
                                        <p style={{marginBottom: '15px', color: '#666'}}>
                                            ÏÑ†ÌÉùÌïú <strong style={{color: '#dc3545'}}>{selectedCosts.length}Í∞ú</strong> Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÎ†§Î©¥ Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.
                                        </p>
                                        <div className="form-group">
                                            <label>Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                                            <input 
                                                type="password"
                                                value={deletePassword}
                                                onChange={(e) => setDeletePassword(e.target.value)}
                                                placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                                required
                                                autoFocus
                                            />
                                        </div>
                                    </div>
                                    <div className="modal-actions" style={{padding: '15px 20px', borderTop: '1px solid #eee'}}>
                                        <button 
                                            type="button" 
                                            className="btn btn-secondary btn-sm"
                                            onClick={() => setShowDeleteModal(false)}
                                            disabled={isDeleting}
                                        >
                                            Ï∑®ÏÜå
                                        </button>
                                        <button 
                                            type="submit" 
                                            className="btn btn-danger btn-sm"
                                            disabled={isDeleting}
                                        >
                                            {isDeleting ? 'ÏÇ≠Ï†ú Ï§ë...' : 'ÏÇ≠Ï†ú'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îã¨ */}
                    {showImageModal && previewImages.length > 0 && (
                        <div className="modal-overlay" onClick={() => setShowImageModal(false)}>
                            <div className="image-modal" onClick={(e) => e.stopPropagation()}>
                                <div className="image-modal-header">
                                    <h3>Ï¶ùÎπô Ïù¥ÎØ∏ÏßÄ ({currentImageIndex + 1} / {previewImages.length})</h3>
                                    <button className="image-modal-close" onClick={() => setShowImageModal(false)}>
                                        √ó
                                    </button>
                                </div>
                                <div className="image-modal-body">
                                    {previewImages.length > 1 && (
                                        <button className="image-nav-btn prev" onClick={handlePrevImage}>
                                            ‚Äπ
                                        </button>
                                    )}
                                    <img 
                                        src={previewImages[currentImageIndex]?.url} 
                                        alt={`Ï¶ùÎπô Ïù¥ÎØ∏ÏßÄ ${currentImageIndex + 1}`}
                                    />
                                    {previewImages.length > 1 && (
                                        <button className="image-nav-btn next" onClick={handleNextImage}>
                                            ‚Ä∫
                                        </button>
                                    )}
                                </div>
                                {previewImages.length > 1 && (
                                    <div className="image-modal-footer">
                                        {previewImages.map((_, index) => (
                                            <div 
                                                key={index}
                                                className={`image-dot ${index === currentImageIndex ? 'active' : ''}`}
                                                onClick={() => setCurrentImageIndex(index)}
                                            />
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Round Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ
        function RoundManagementPage() {
            const [activeTab, setActiveTab] = useState('date');
            const [branches, setBranches] = useState([]);
            const [costs, setCosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [rounds, setRounds] = useState([]);
            const [newRound, setNewRound] = useState({
                name: '',
                startDate: '',
                endDate: ''
            });
            
            // ÏßÄÏ†êÎ≥Ñ ÎπÑÏö© Î∞∞Ï†ï Í¥ÄÎ†® ÏÉÅÌÉú
            const [selectedRoundId, setSelectedRoundId] = useState('');
            const [branchBudgets, setBranchBudgets] = useState({});
            const [isSavingBudget, setIsSavingBudget] = useState(false);

            // Í∏àÏï° Ìè¨Îß∑
            const formatAmount = (amount) => {
                return new Intl.NumberFormat('ko-KR', {
                    style: 'currency',
                    currency: 'KRW'
                }).format(amount);
            };

            // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            useEffect(() => {
                const loadData = async () => {
                    setLoading(true);
                    
                    // ÏÇ¨Ïö©Ïûê Î™©Î°ùÏóêÏÑú ÏßÄÏ†êÎ™Ö Í∞ÄÏ†∏Ïò§Í∏∞
                    const usersResult = await getAllUsers();
                    if (usersResult.success) {
                        const branchSet = new Set();
                        usersResult.users.forEach(user => {
                            if (user.branchName) {
                                branchSet.add(user.branchName);
                            }
                        });
                        setBranches([...branchSet].sort());
                    }

                    // ÎπÑÏö© Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                    const unsubscribe = db.collection('costs')
                        .onSnapshot((snapshot) => {
                            const costsData = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setCosts(costsData);
                            setLoading(false);
                        });

                    // Round Î™©Î°ù Î°úÎìú
                    const roundsUnsubscribe = db.collection('rounds')
                        .orderBy('createdAt', 'desc')
                        .onSnapshot((snapshot) => {
                            const roundsData = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setRounds(roundsData);
                        });

                    return () => {
                        unsubscribe();
                        roundsUnsubscribe();
                    };
                };

                loadData();
            }, []);

            // ÏßÄÏ†êÎ≥Ñ ÎπÑÏö© Í≥ÑÏÇ∞ (ÏÑ†ÌÉùÎêú ÎùºÏö¥Îìú Í∏∞Í∞Ñ ÎÇ¥)
            const getBranchCosts = (branchName) => {
                const selectedRound = rounds.find(r => r.id === selectedRoundId);
                
                return costs
                    .filter(cost => {
                        if (cost.branchName !== branchName) return false;
                        
                        // ÎùºÏö¥ÎìúÍ∞Ä ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ Ìï¥Îãπ Í∏∞Í∞Ñ ÎÇ¥ ÎπÑÏö©Îßå Í≥ÑÏÇ∞
                        if (selectedRound) {
                            const costDate = new Date(cost.date);
                            const startDate = new Date(selectedRound.startDate);
                            const endDate = new Date(selectedRound.endDate);
                            endDate.setHours(23, 59, 59, 999);
                            return costDate >= startDate && costDate <= endDate;
                        }
                        
                        return true;
                    })
                    .reduce((sum, cost) => sum + Number(cost.amount || 0), 0);
            };

            // ÏßÄÏ†êÎ≥Ñ ÎπÑÏö© Í±¥Ïàò (ÏÑ†ÌÉùÎêú ÎùºÏö¥Îìú Í∏∞Í∞Ñ ÎÇ¥)
            const getBranchCostCount = (branchName) => {
                const selectedRound = rounds.find(r => r.id === selectedRoundId);
                
                return costs.filter(cost => {
                    if (cost.branchName !== branchName) return false;
                    
                    if (selectedRound) {
                        const costDate = new Date(cost.date);
                        const startDate = new Date(selectedRound.startDate);
                        const endDate = new Date(selectedRound.endDate);
                        endDate.setHours(23, 59, 59, 999);
                        return costDate >= startDate && costDate <= endDate;
                    }
                    
                    return true;
                }).length;
            };

            // ÎùºÏö¥Îìú ÏÑ†ÌÉù Ïãú Î∞∞Ï†ï ÎπÑÏö© Î°úÎìú
            const handleRoundSelect = async (roundId) => {
                setSelectedRoundId(roundId);
                
                if (!roundId) {
                    setBranchBudgets({});
                    return;
                }
                
                try {
                    const doc = await db.collection('roundBudgets').doc(roundId).get();
                    if (doc.exists) {
                        setBranchBudgets(doc.data().budgets || {});
                    } else {
                        // Ï¥àÍ∏∞Í∞í ÏÑ§Ï†ï (Î™®Îì† ÏßÄÏ†ê 0Ïõê)
                        const initialBudgets = {};
                        branches.forEach(branch => {
                            initialBudgets[branch] = 0;
                        });
                        setBranchBudgets(initialBudgets);
                    }
                } catch (error) {
                    console.error('Î∞∞Ï†ï ÎπÑÏö© Î°úÎìú Ïò§Î•ò:', error);
                    setBranchBudgets({});
                }
            };

            // ÏßÄÏ†êÎ≥Ñ Î∞∞Ï†ï ÎπÑÏö© Î≥ÄÍ≤Ω
            const handleBudgetChange = (branch, value) => {
                const numericValue = value.replace(/[^\d]/g, '');
                setBranchBudgets(prev => ({
                    ...prev,
                    [branch]: Number(numericValue) || 0
                }));
            };

            // Î∞∞Ï†ï ÎπÑÏö© Ï†ÄÏû•
            const handleSaveBudgets = async () => {
                if (!selectedRoundId) {
                    alert('ÎùºÏö¥ÎìúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                setIsSavingBudget(true);
                
                try {
                    await db.collection('roundBudgets').doc(selectedRoundId).set({
                        roundId: selectedRoundId,
                        budgets: branchBudgets,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Î∞∞Ï†ï ÎπÑÏö©Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                } catch (error) {
                    console.error('Î∞∞Ï†ï ÎπÑÏö© Ï†ÄÏû• Ïò§Î•ò:', error);
                    alert('Î∞∞Ï†ï ÎπÑÏö© Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                } finally {
                    setIsSavingBudget(false);
                }
            };

            // Í∏àÏï° ÏûÖÎ†• Ìè¨Îß∑
            const formatBudgetInput = (value) => {
                return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            };

            // Ï†ÑÏ≤¥ Î∞∞Ï†ï ÎπÑÏö© Ìï©Í≥Ñ
            const getTotalBudget = () => {
                return Object.values(branchBudgets).reduce((sum, val) => sum + Number(val || 0), 0);
            };

            // ÏßÄÏ†êÎ≥Ñ ÎπÑÏö© ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
            const handleExportBranchCosts = () => {
                if (branches.length === 0) {
                    alert('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                const selectedRound = rounds.find(r => r.id === selectedRoundId);
                const roundName = selectedRound ? selectedRound.name : 'Ï†ÑÏ≤¥';

                // CSV Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                const headers = ['ÏßÄÏ†êÎ™Ö', 'Î∞∞Ï†ï ÎπÑÏö©', 'ÏÇ¨Ïö© ÎπÑÏö©', 'ÏûîÏó¨ ÎπÑÏö©', 'ÏÇ¨Ïö©Î•†(%)'];
                const rows = branches.map(branch => {
                    const budget = branchBudgets[branch] || 0;
                    const used = getBranchCosts(branch);
                    const remaining = budget - used;
                    const usageRate = budget > 0 ? Math.round((used / budget) * 100) : 0;
                    return [
                        branch,
                        budget,
                        used,
                        remaining,
                        usageRate
                    ];
                });

                // Ìï©Í≥Ñ Ìñâ Ï∂îÍ∞Ä
                const totalBudget = getTotalBudget();
                const totalUsed = branches.reduce((sum, b) => sum + getBranchCosts(b), 0);
                const totalRemaining = totalBudget - totalUsed;
                const totalRate = totalBudget > 0 ? Math.round((totalUsed / totalBudget) * 100) : 0;
                rows.push(['Ìï©Í≥Ñ', totalBudget, totalUsed, totalRemaining, totalRate]);

                // BOM Ï∂îÍ∞Ä (ÌïúÍ∏Ä Íπ®Ïßê Î∞©ÏßÄ)
                const BOM = '\uFEFF';
                const csvContent = BOM + [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                ].join('\n');

                // ÌååÏùº Îã§Ïö¥Î°úÎìú
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                const fileName = `ÏßÄÏ†êÎ≥ÑÎπÑÏö©_${roundName}_${new Date().toLocaleDateString('ko-KR').replace(/\./g, '')}.csv`;
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Round Ï∂îÍ∞Ä
            const handleAddRound = async (e) => {
                e.preventDefault();
                
                if (!newRound.name || !newRound.startDate || !newRound.endDate) {
                    alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                try {
                    await db.collection('rounds').add({
                        name: newRound.name,
                        startDate: newRound.startDate,
                        endDate: newRound.endDate,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setNewRound({ name: '', startDate: '', endDate: '' });
                    alert('RoundÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
                } catch (error) {
                    console.error('Round Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                    alert('Round Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            };

            // Round ÏÇ≠Ï†ú
            const handleDeleteRound = async (roundId) => {
                if (!confirm('Ïù¥ RoundÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
                
                try {
                    await db.collection('rounds').doc(roundId).delete();
                    alert('RoundÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                } catch (error) {
                    console.error('Round ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                    alert('Round ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            };

            if (loading) {
                return (
                    <div className="loading-spinner">
                        <p>Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
                    </div>
                );
            }

            return (
                <div>
                    <div className="page-header">
                        <h2 className="page-title">Round Í¥ÄÎ¶¨</h2>
                        <p className="page-subtitle">Round Í∏∞Í∞Ñ ÏÑ§Ï†ï Î∞è ÏßÄÏ†êÎ≥Ñ ÎπÑÏö©ÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§</p>
                    </div>

                    <div className="content-area">
                        {/* ÌÉ≠ Î≤ÑÌäº */}
                        <div className="tab-buttons">
                            <button 
                                className={`tab-button ${activeTab === 'date' ? 'active' : ''}`}
                                onClick={() => setActiveTab('date')}
                            >
                                Round ÎÇ†Ïßú ÏßÄÏ†ï
                            </button>
                            <button 
                                className={`tab-button ${activeTab === 'branch' ? 'active' : ''}`}
                                onClick={() => setActiveTab('branch')}
                            >
                                ÏßÄÏ†êÎ≥Ñ ÎπÑÏö©
                            </button>
                        </div>

                        {/* ÌÉ≠ Ïª®ÌÖêÏ∏† */}
                        <div className="tab-content">
                            {activeTab === 'date' && (
                                <div>
                                    {/* Round Ï∂îÍ∞Ä Ìèº */}
                                    <div className="round-card">
                                        <div className="round-card-header">
                                            <h4 className="round-card-title">ÏÉà Round Ï∂îÍ∞Ä</h4>
                                        </div>
                                        <form onSubmit={handleAddRound}>
                                            <div className="form-group" style={{marginBottom: '16px'}}>
                                                <label>Round Ïù¥Î¶Ñ</label>
                                                <input 
                                                    type="text"
                                                    value={newRound.name}
                                                    onChange={(e) => setNewRound({...newRound, name: e.target.value})}
                                                    placeholder="Ïòà: 2025ÎÖÑ 1Round"
                                                />
                                            </div>
                                            <div className="round-date-inputs">
                                                <div className="form-group">
                                                    <label>ÏãúÏûëÏùº</label>
                                                    <input 
                                                        type="date"
                                                        value={newRound.startDate}
                                                        onChange={(e) => setNewRound({...newRound, startDate: e.target.value})}
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>Ï¢ÖÎ£åÏùº</label>
                                                    <input 
                                                        type="date"
                                                        value={newRound.endDate}
                                                        onChange={(e) => setNewRound({...newRound, endDate: e.target.value})}
                                                    />
                                                </div>
                                            </div>
                                            <button type="submit" className="btn" style={{marginTop: '16px'}}>
                                                Round Ï∂îÍ∞Ä
                                            </button>
                                        </form>
                                    </div>

                                    {/* Round Î™©Î°ù */}
                                    <h4 style={{marginBottom: '16px', color: '#001236'}}>Îì±Î°ùÎêú Round Î™©Î°ù</h4>
                                    {rounds.length === 0 ? (
                                        <p style={{color: '#666'}}>Îì±Î°ùÎêú RoundÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                                    ) : (
                                        rounds.map(round => (
                                            <div key={round.id} className="round-card">
                                                <div className="round-card-header">
                                                    <h4 className="round-card-title">{round.name}</h4>
                                                    <button 
                                                        className="btn btn-sm btn-danger"
                                                        onClick={() => handleDeleteRound(round.id)}
                                                    >
                                                        ÏÇ≠Ï†ú
                                                    </button>
                                                </div>
                                                <p style={{color: '#666', fontSize: '14px'}}>
                                                    {round.startDate} ~ {round.endDate}
                                                </p>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}

                            {activeTab === 'branch' && (
                                <div>
                                    {/* ÎùºÏö¥Îìú ÏÑ†ÌÉù */}
                                    <div className="round-card" style={{marginBottom: '24px'}}>
                                        <div className="round-card-header">
                                            <h4 className="round-card-title">Round ÏÑ†ÌÉù</h4>
                                        </div>
                                        <div style={{display: 'flex', gap: '16px', alignItems: 'center'}}>
                                            <select
                                                value={selectedRoundId}
                                                onChange={(e) => handleRoundSelect(e.target.value)}
                                                style={{
                                                    flex: 1,
                                                    padding: '12px 16px',
                                                    borderRadius: '8px',
                                                    border: '2px solid #e0e0e0',
                                                    fontSize: '14px'
                                                }}
                                            >
                                                <option value="">-- RoundÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî --</option>
                                                {rounds.map(round => (
                                                    <option key={round.id} value={round.id}>
                                                        {round.name} ({round.startDate} ~ {round.endDate})
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        {rounds.length === 0 && (
                                            <p style={{color: '#999', fontSize: '13px', marginTop: '10px'}}>
                                                Î®ºÏ†Ä "Round ÎÇ†Ïßú ÏßÄÏ†ï" ÌÉ≠ÏóêÏÑú RoundÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.
                                            </p>
                                        )}
                                    </div>

                                    {selectedRoundId ? (
                                        <>
                                            {/* ÌÜµÍ≥Ñ Ïπ¥Îìú */}
                                            <div className="stats-grid" style={{marginBottom: '24px'}}>
                                                <div className="stat-card">
                                                    <h3>Ï†ÑÏ≤¥ ÏßÄÏ†ê Ïàò</h3>
                                                    <div className="value">{branches.length}</div>
                                                </div>
                                                <div className="stat-card">
                                                    <h3>Ï¥ù Î∞∞Ï†ï ÎπÑÏö©</h3>
                                                    <div className="value">{formatAmount(getTotalBudget())}</div>
                                                </div>
                                                <div className="stat-card">
                                                    <h3>Ï¥ù ÏÇ¨Ïö© ÎπÑÏö©</h3>
                                                    <div className="value">
                                                        {formatAmount(branches.reduce((sum, b) => sum + getBranchCosts(b), 0))}
                                                    </div>
                                                </div>
                                            </div>

                                            {branches.length === 0 ? (
                                                <p style={{color: '#666'}}>Îì±Î°ùÎêú ÏßÄÏ†êÏù¥ ÏóÜÏäµÎãàÎã§. ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ÏóêÏÑú ÏßÄÏ†êÎ™ÖÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.</p>
                                            ) : (
                                                <>
                                                    <table className="branch-cost-table">
                                                        <thead>
                                                            <tr>
                                                                <th>ÏßÄÏ†êÎ™Ö</th>
                                                                <th style={{width: '180px'}}>Î∞∞Ï†ï ÎπÑÏö©</th>
                                                                <th>ÏÇ¨Ïö© ÎπÑÏö©</th>
                                                                <th>ÏûîÏó¨ ÎπÑÏö©</th>
                                                                <th>ÏÇ¨Ïö©Î•†</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {branches.map(branch => {
                                                                const budget = branchBudgets[branch] || 0;
                                                                const used = getBranchCosts(branch);
                                                                const remaining = budget - used;
                                                                const usageRate = budget > 0 ? Math.round((used / budget) * 100) : 0;
                                                                
                                                                return (
                                                                    <tr key={branch}>
                                                                        <td>
                                                                            <span style={{
                                                                                background: '#f07c00',
                                                                                color: 'white',
                                                                                padding: '4px 12px',
                                                                                borderRadius: '4px',
                                                                                fontSize: '13px',
                                                                                fontWeight: '600'
                                                                            }}>
                                                                                {branch}
                                                                            </span>
                                                                        </td>
                                                                        <td>
                                                                            <input
                                                                                type="text"
                                                                                value={formatBudgetInput(budget)}
                                                                                onChange={(e) => handleBudgetChange(branch, e.target.value)}
                                                                                style={{
                                                                                    width: '100%',
                                                                                    padding: '8px 12px',
                                                                                    borderRadius: '6px',
                                                                                    border: '2px solid #e0e0e0',
                                                                                    fontSize: '14px',
                                                                                    textAlign: 'right'
                                                                                }}
                                                                                placeholder="0"
                                                                            />
                                                                        </td>
                                                                        <td className="amount">{formatAmount(used)}</td>
                                                                        <td style={{
                                                                            color: remaining >= 0 ? '#28a745' : '#dc3545',
                                                                            fontWeight: '600'
                                                                        }}>
                                                                            {formatAmount(remaining)}
                                                                        </td>
                                                                        <td>
                                                                            <div style={{
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                gap: '8px'
                                                                            }}>
                                                                                <div style={{
                                                                                    flex: 1,
                                                                                    height: '8px',
                                                                                    background: '#e0e0e0',
                                                                                    borderRadius: '4px',
                                                                                    overflow: 'hidden'
                                                                                }}>
                                                                                    <div style={{
                                                                                        width: `${Math.min(usageRate, 100)}%`,
                                                                                        height: '100%',
                                                                                        background: usageRate > 100 ? '#dc3545' : usageRate > 80 ? '#ffc107' : '#28a745',
                                                                                        transition: 'width 0.3s ease'
                                                                                    }} />
                                                                                </div>
                                                                                <span style={{
                                                                                    fontSize: '13px',
                                                                                    fontWeight: '600',
                                                                                    color: usageRate > 100 ? '#dc3545' : '#333',
                                                                                    minWidth: '45px'
                                                                                }}>
                                                                                    {usageRate}%
                                                                                </span>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    
                                                    <div style={{marginTop: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                                        <button 
                                                            className="btn btn-success"
                                                            onClick={handleExportBranchCosts}
                                                        >
                                                            üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
                                                        </button>
                                                        <button 
                                                            className="btn"
                                                            onClick={handleSaveBudgets}
                                                            disabled={isSavingBudget}
                                                        >
                                                            {isSavingBudget ? 'Ï†ÄÏû• Ï§ë...' : 'Î∞∞Ï†ï ÎπÑÏö© Ï†ÄÏû•'}
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </>
                                    ) : (
                                        <div style={{
                                            textAlign: 'center',
                                            padding: '60px 20px',
                                            color: '#999'
                                        }}>
                                            <p style={{fontSize: '16px', marginBottom: '8px'}}>RoundÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</p>
                                            <p style={{fontSize: '13px'}}>ÏúÑÏóêÏÑú RoundÎ•º ÏÑ†ÌÉùÌïòÎ©¥ ÏßÄÏ†êÎ≥Ñ ÎπÑÏö©ÏùÑ Î∞∞Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ
        function UsersPage() {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showModal, setShowModal] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [formData, setFormData] = useState({
                email: '',
                password: '',
                displayName: '',
                branchName: ''
            });
            const [selectedUsers, setSelectedUsers] = useState([]);
            
            // ÏÇ≠Ï†ú ÌôïÏù∏ Î™®Îã¨ ÏÉÅÌÉú
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [deletePassword, setDeletePassword] = useState('');
            const [isDeleting, setIsDeleting] = useState(false);

            // ÏÇ¨Ïö©Ïûê Î™©Î°ù Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà
            useEffect(() => {
                setLoading(true);
                const unsubscribe = db.collection('users').onSnapshot(
                    (snapshot) => {
                        const usersData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Ï†ïÎ†¨ (createdAt Í∏∞Ï§Ä ÎÇ¥Î¶ºÏ∞®Ïàú)
                        usersData.sort((a, b) => {
                            const dateA = a.createdAt?.toDate?.() || new Date(0);
                            const dateB = b.createdAt?.toDate?.() || new Date(0);
                            return dateB - dateA;
                        });
                        setUsers(usersData);
                        setLoading(false);
                    },
                    (error) => {
                        console.error('ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                        setLoading(false);
                    }
                );

                return () => unsubscribe();
            }, []);

            // ÏàòÎèô ÏÉàÎ°úÍ≥†Ïπ®Ïö© (ÏÇ≠Ï†ú ÌõÑ ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî Îì±)
            const loadUsers = async () => {
                setSelectedUsers([]); // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
            };

            // Ï≤¥ÌÅ¨Î∞ïÏä§ - Í∞úÎ≥Ñ ÏÑ†ÌÉù
            const handleSelectUser = (uid) => {
                setSelectedUsers(prev => {
                    if (prev.includes(uid)) {
                        return prev.filter(id => id !== uid);
                    } else {
                        return [...prev, uid];
                    }
                });
            };

            // Ï≤¥ÌÅ¨Î∞ïÏä§ - Ï†ÑÏ≤¥ ÏÑ†ÌÉù
            const handleSelectAll = () => {
                if (selectedUsers.length === users.filter(u => u.role !== 'admin').length) {
                    setSelectedUsers([]);
                } else {
                    // Í¥ÄÎ¶¨ÏûêÎäî Ï†úÏô∏ÌïòÍ≥† ÏÑ†ÌÉù
                    setSelectedUsers(users.filter(u => u.role !== 'admin').map(u => u.uid));
                }
            };

            // ÏÑ†ÌÉùÎêú ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú Î™®Îã¨ Ïó¥Í∏∞
            const handleDeleteSelected = () => {
                if (selectedUsers.length === 0) {
                    alert('ÏÇ≠Ï†úÌï† ÏÇ¨Ïö©ÏûêÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                setDeletePassword('');
                setShowDeleteModal(true);
            };

            // ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ ÌõÑ Ïã§Ï†ú ÏÇ≠Ï†ú Ïã§Ìñâ (Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÇ¨Ïö©)
            const confirmDelete = async () => {
                if (!deletePassword) {
                    alert('Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                setIsDeleting(true);

                try {
                    // FirestoreÏóêÏÑú Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
                    const doc = await db.collection('settings').doc('roundPassword').get();
                    
                    if (!doc.exists) {
                        alert('Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Firebase ConsoleÏóêÏÑú ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                        setIsDeleting(false);
                        return;
                    }
                    
                    const storedPassword = doc.data().password;
                    
                    if (deletePassword !== storedPassword) {
                        alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
                        setIsDeleting(false);
                        return;
                    }

                    // ÏÇ≠Ï†ú Ïã§Ìñâ
                    let successCount = 0;
                    let failCount = 0;

                    for (const uid of selectedUsers) {
                        const result = await deleteUserFromFirestore(uid);
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    }

                    alert(`ÏÇ≠Ï†ú ÏôÑÎ£å: ${successCount}Î™Ö ÏÑ±Í≥µ, ${failCount}Î™Ö Ïã§Ìå®`);
                    setShowDeleteModal(false);
                    setDeletePassword('');
                    loadUsers();

                } catch (error) {
                    console.error('ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                    alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
                } finally {
                    setIsDeleting(false);
                }
            };

            // Î™®Îã¨ Ïó¥Í∏∞ (Ïã†Í∑ú Îì±Î°ù)
            const openAddModal = () => {
                setEditingUser(null);
                setFormData({
                    email: '',
                    password: '',
                    displayName: '',
                    branchName: '',
                    adminPassword: ''
                });
                setShowModal(true);
            };

            // Î™®Îã¨ Ïó¥Í∏∞ (ÏàòÏ†ï)
            const openEditModal = (user) => {
                setEditingUser(user);
                setFormData({
                    email: user.email,
                    password: '',
                    displayName: user.displayName || '',
                    branchName: user.branchName || '',
                    adminPassword: ''
                });
                setShowModal(true);
            };

            // ÏÇ¨Ïö©Ïûê Îì±Î°ù/ÏàòÏ†ï
            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (editingUser) {
                    // ÏàòÏ†ï
                    const result = await updateUser(editingUser.uid, {
                        displayName: formData.displayName,
                        branchName: formData.branchName
                    });
                    if (result.success) {
                        alert('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
                        setShowModal(false);
                        loadUsers();
                    } else {
                        alert(result.message);
                    }
                } else {
                    // Ïã†Í∑ú Îì±Î°ù
                    if (!formData.email || !formData.password) {
                        alert('Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }
                    if (!formData.adminPassword) {
                        alert('Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }
                    
                    // ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± Ï§ë ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï (Î¶¨Îã§Ïù¥Î†âÌä∏ Î∞©ÏßÄ)
                    isCreatingUser = true;
                    
                    // Í¥ÄÎ¶¨ÏûêÏö© ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± (ÏÉùÏÑ± ÌõÑ Í¥ÄÎ¶¨ÏûêÎ°ú Ïû¨Î°úÍ∑∏Ïù∏)
                    const result = await createUserByAdmin(
                        formData.email,
                        formData.password,
                        ADMIN_EMAIL,
                        formData.adminPassword,
                        formData.displayName,
                        formData.branchName
                    );
                    
                    // ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                    isCreatingUser = false;
                    
                    if (result.success) {
                        alert('ÏÇ¨Ïö©ÏûêÍ∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
                        setShowModal(false);
                        loadUsers();
                    } else {
                        alert(result.message);
                    }
                }
            };

            // ÏÇ¨Ïö©Ïûê ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
            const handleToggleActive = async (user) => {
                const newStatus = !user.isActive;
                const result = await toggleUserActive(user.uid, newStatus);
                if (result.success) {
                    loadUsers();
                } else {
                    alert(result.message);
                }
            };

            // ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú
            const handleDelete = async (user) => {
                if (!confirm(`"${user.email}" ÏÇ¨Ïö©ÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
                
                const result = await deleteUserFromFirestore(user.uid);
                if (result.success) {
                    alert('ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    loadUsers();
                } else {
                    alert(result.message);
                }
            };

            return (
                <div>
                    <div className="page-header">
                        <h2 className="page-title">ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨</h2>
                        <p className="page-subtitle">Îì±Î°ùÎêú ÏÇ¨Ïö©ÏûêÎ•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§</p>
                    </div>

                    <div className="stats-grid">
                        <div className="stat-card">
                            <h3>Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê</h3>
                            <div className="value">{users.length}</div>
                        </div>
                        <div className="stat-card">
                            <h3>ÌôúÏÑ± ÏÇ¨Ïö©Ïûê</h3>
                            <div className="value">{users.filter(u => u.isActive).length}</div>
                        </div>
                        <div className="stat-card">
                            <h3>ÎπÑÌôúÏÑ± ÏÇ¨Ïö©Ïûê</h3>
                            <div className="value">{users.filter(u => !u.isActive).length}</div>
                        </div>
                    </div>

                    <div className="content-area">
                        <div className="page-header-actions">
                            <div style={{display: 'flex', alignItems: 'center', gap: '15px'}}>
                                <h3 className="section-title" style={{marginBottom: 0}}>ÏÇ¨Ïö©Ïûê Î™©Î°ù</h3>
                                {selectedUsers.length > 0 && (
                                    <span style={{fontSize: '14px', color: '#f07c00'}}>{selectedUsers.length}Î™Ö ÏÑ†ÌÉùÎê®</span>
                                )}
                            </div>
                            <div style={{display: 'flex', gap: '10px'}}>
                                {selectedUsers.length > 0 && (
                                    <button className="btn btn-danger" onClick={handleDeleteSelected}>
                                        ÏÑ†ÌÉù ÏÇ≠Ï†ú ({selectedUsers.length})
                                    </button>
                                )}
                                <button className="btn" onClick={openAddModal}>+ ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä</button>
                            </div>
                        </div>

                        {loading ? (
                            <div className="loading-spinner">ÏÇ¨Ïö©Ïûê Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                        ) : users.length === 0 ? (
                            <div className="empty-state">Îì±Î°ùÎêú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>
                        ) : (
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th style={{width: '40px'}}>
                                            <input 
                                                type="checkbox"
                                                checked={selectedUsers.length === users.filter(u => u.role !== 'admin').length && users.filter(u => u.role !== 'admin').length > 0}
                                                onChange={handleSelectAll}
                                                style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                            />
                                        </th>
                                        <th>Ïù¥Î©îÏùº</th>
                                        <th>Ïù¥Î¶Ñ</th>
                                        <th>ÏßÄÏ†êÎ™Ö</th>
                                        <th>Ïó≠Ìï†</th>
                                        <th>ÏÉÅÌÉú</th>
                                        <th>Í∞ÄÏûÖÏùº</th>
                                        <th>ÎßàÏßÄÎßâ Î°úÍ∑∏Ïù∏</th>
                                        <th>Í¥ÄÎ¶¨</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {users.map(user => (
                                        <tr key={user.uid} style={{background: selectedUsers.includes(user.uid) ? 'rgba(240, 124, 0, 0.1)' : 'transparent'}}>
                                            <td>
                                                {user.role !== 'admin' ? (
                                                    <input 
                                                        type="checkbox"
                                                        checked={selectedUsers.includes(user.uid)}
                                                        onChange={() => handleSelectUser(user.uid)}
                                                        style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                                    />
                                                ) : (
                                                    <span style={{color: '#999', fontSize: '12px'}}>-</span>
                                                )}
                                            </td>
                                            <td>{user.email}</td>
                                            <td>{user.displayName || '-'}</td>
                                            <td>{user.branchName || '-'}</td>
                                            <td>
                                                <span className={`status-badge ${user.role === 'admin' ? 'admin' : ''}`}>
                                                    {user.role === 'admin' ? 'Í¥ÄÎ¶¨Ïûê' : 'ÏÇ¨Ïö©Ïûê'}
                                                </span>
                                            </td>
                                            <td>
                                                <span className={`status-badge ${user.isActive ? 'active' : 'inactive'}`}>
                                                    {user.isActive ? 'ÌôúÏÑ±' : 'ÎπÑÌôúÏÑ±'}
                                                </span>
                                            </td>
                                            <td>{formatDate(user.createdAt)}</td>
                                            <td>{formatDate(user.lastLoginAt)}</td>
                                            <td>
                                                <div className="actions">
                                                    <button 
                                                        className="btn btn-sm btn-secondary"
                                                        onClick={() => openEditModal(user)}
                                                    >
                                                        ÏàòÏ†ï
                                                    </button>
                                                    {user.role !== 'admin' && (
                                                        <button 
                                                            className={`btn btn-sm ${user.isActive ? 'btn-danger' : 'btn-success'}`}
                                                            onClick={() => handleToggleActive(user)}
                                                        >
                                                            {user.isActive ? 'ÎπÑÌôúÏÑ±Ìôî' : 'ÌôúÏÑ±Ìôî'}
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>

                    {/* ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä/ÏàòÏ†ï Î™®Îã¨ */}
                    {showModal && (
                        <div className="modal-overlay" onClick={() => setShowModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>{editingUser ? 'ÏÇ¨Ïö©Ïûê ÏàòÏ†ï' : 'ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä'}</h3>
                                    <button className="modal-close" onClick={() => setShowModal(false)}>√ó</button>
                                </div>
                                <form onSubmit={handleSubmit}>
                                    <div className="form-group">
                                        <label>Ïù¥Î©îÏùº</label>
                                        <input
                                            type="email"
                                            value={formData.email}
                                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                                            disabled={!!editingUser}
                                            required
                                        />
                                    </div>
                                    {!editingUser && (
                                        <div className="form-group">
                                            <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                                            <input
                                                type="password"
                                                value={formData.password}
                                                onChange={(e) => setFormData({...formData, password: e.target.value})}
                                                placeholder="ÏµúÏÜå 6Ïûê Ïù¥ÏÉÅ"
                                                required
                                            />
                                        </div>
                                    )}
                                    <div className="form-group">
                                        <label>Ïù¥Î¶Ñ</label>
                                        <input
                                            type="text"
                                            value={formData.displayName}
                                            onChange={(e) => setFormData({...formData, displayName: e.target.value})}
                                            placeholder="ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>ÏßÄÏ†êÎ™Ö</label>
                                        <input
                                            type="text"
                                            value={formData.branchName}
                                            onChange={(e) => setFormData({...formData, branchName: e.target.value})}
                                            placeholder="ÏÜåÏÜç ÏßÄÏ†êÎ™Ö"
                                        />
                                    </div>
                                    {!editingUser && (
                                        <div className="form-group" style={{marginTop: '20px', paddingTop: '20px', borderTop: '1px solid #eee'}}>
                                            <label style={{color: '#f07c00'}}>Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
                                            <input
                                                type="password"
                                                value={formData.adminPassword}
                                                onChange={(e) => setFormData({...formData, adminPassword: e.target.value})}
                                                placeholder="Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                                required
                                            />
                                            <p style={{fontSize: '12px', color: '#666', marginTop: '5px'}}>
                                                ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä ÌõÑ Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ï Ïú†ÏßÄÎ•º ÏúÑÌï¥ ÌïÑÏöîÌï©ÎãàÎã§
                                            </p>
                                        </div>
                                    )}
                                    <div className="modal-actions">
                                        <button type="button" className="btn btn-secondary" onClick={() => setShowModal(false)}>
                                            Ï∑®ÏÜå
                                        </button>
                                        <button type="submit" className="btn">
                                            {editingUser ? 'ÏàòÏ†ï' : 'Îì±Î°ù'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* ÏÇ≠Ï†ú ÌôïÏù∏ Î™®Îã¨ */}
                    {showDeleteModal && (
                        <div className="modal-overlay" onClick={() => !isDeleting && setShowDeleteModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '400px'}}>
                                <div className="modal-header">
                                    <h3 style={{color: '#dc3545'}}>‚ö†Ô∏è ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú</h3>
                                    <button 
                                        className="modal-close" 
                                        onClick={() => setShowDeleteModal(false)}
                                        disabled={isDeleting}
                                    >√ó</button>
                                </div>
                                <div style={{marginBottom: '20px'}}>
                                    <p style={{color: '#666', marginBottom: '15px'}}>
                                        ÏÑ†ÌÉùÌïú <strong style={{color: '#dc3545'}}>{selectedUsers.length}Î™Ö</strong>Ïùò ÏÇ¨Ïö©ÏûêÎ•º ÏÇ≠Ï†úÌï©ÎãàÎã§.
                                    </p>
                                    <div style={{
                                        background: '#f8f9fa',
                                        padding: '12px',
                                        borderRadius: '8px',
                                        maxHeight: '100px',
                                        overflowY: 'auto',
                                        fontSize: '13px',
                                        color: '#333'
                                    }}>
                                        {users
                                            .filter(u => selectedUsers.includes(u.uid))
                                            .map(u => u.email)
                                            .join(', ')}
                                    </div>
                                    <p style={{fontSize: '12px', color: '#dc3545', marginTop: '10px'}}>
                                        Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.
                                    </p>
                                </div>
                                <div className="form-group">
                                    <label style={{color: '#dc3545'}}>Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
                                    <input
                                        type="password"
                                        value={deletePassword}
                                        onChange={(e) => setDeletePassword(e.target.value)}
                                        placeholder="Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                        disabled={isDeleting}
                                        onKeyPress={(e) => e.key === 'Enter' && confirmDelete()}
                                        autoFocus
                                    />
                                </div>
                                <div className="modal-actions">
                                    <button 
                                        type="button" 
                                        className="btn btn-secondary" 
                                        onClick={() => setShowDeleteModal(false)}
                                        disabled={isDeleting}
                                    >
                                        Ï∑®ÏÜå
                                    </button>
                                    <button 
                                        type="button" 
                                        className="btn btn-danger" 
                                        onClick={confirmDelete}
                                        disabled={isDeleting || !deletePassword}
                                    >
                                        {isDeleting ? 'ÏÇ≠Ï†ú Ï§ë...' : 'ÏÇ≠Ï†ú ÌôïÏù∏'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ÏÑ§Ï†ï ÌéòÏù¥ÏßÄ
        function SettingsPage() {
            const [user, setUser] = useState(null);
            
            // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Í¥ÄÎ†® ÏÉÅÌÉú
            const [uniquePassword, setUniquePassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [isChangingPassword, setIsChangingPassword] = useState(false);
            const [passwordMessage, setPasswordMessage] = useState({ type: '', text: '' });

            useEffect(() => {
                const currentUser = auth.currentUser;
                if (currentUser) {
                    setUser(currentUser);
                }
            }, []);

            // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Ï≤òÎ¶¨ (Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏Î°ú Ïù∏Ï¶ù)
            const handlePasswordChange = async (e) => {
                e.preventDefault();
                setPasswordMessage({ type: '', text: '' });

                // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                if (!uniquePassword) {
                    setPasswordMessage({ type: 'error', text: 'Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.' });
                    return;
                }
                if (!newPassword) {
                    setPasswordMessage({ type: 'error', text: 'ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.' });
                    return;
                }
                if (newPassword.length < 6) {
                    setPasswordMessage({ type: 'error', text: 'ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 6Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.' });
                    return;
                }
                if (newPassword !== confirmPassword) {
                    setPasswordMessage({ type: 'error', text: 'ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.' });
                    return;
                }

                setIsChangingPassword(true);

                try {
                    // FirestoreÏóêÏÑú Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
                    const doc = await db.collection('settings').doc('roundPassword').get();
                    
                    if (!doc.exists) {
                        setPasswordMessage({ type: 'error', text: 'Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.' });
                        setIsChangingPassword(false);
                        return;
                    }
                    
                    const storedPassword = doc.data().password;
                    
                    if (uniquePassword !== storedPassword) {
                        setPasswordMessage({ type: 'error', text: 'Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.' });
                        setIsChangingPassword(false);
                        return;
                    }

                    // ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                    const currentUser = auth.currentUser;
                    await currentUser.updatePassword(newPassword);
                    
                    setPasswordMessage({ type: 'success', text: 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.' });
                    setUniquePassword('');
                    setNewPassword('');
                    setConfirmPassword('');
                } catch (error) {
                    console.error('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
                    if (error.code === 'auth/requires-recent-login') {
                        setPasswordMessage({ type: 'error', text: 'Î≥¥ÏïàÏùÑ ÏúÑÌï¥ Îã§Ïãú Î°úÍ∑∏Ïù∏ ÌõÑ ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.' });
                    } else {
                        setPasswordMessage({ type: 'error', text: 'ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message });
                    }
                } finally {
                    setIsChangingPassword(false);
                }
            };

            return (
                <div>
                    <div className="page-header">
                        <h2 className="page-title">ÏÑ§Ï†ï</h2>
                        <p className="page-subtitle">Í≥ÑÏ†ï ÏÑ§Ï†ïÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§</p>
                    </div>

                    <div className="content-area">
                        {/* Í≥ÑÏ†ï Ï†ïÎ≥¥ */}
                        <div className="settings-section">
                            <h3 className="section-title">Í≥ÑÏ†ï Ï†ïÎ≥¥</h3>
                            <div style={{
                                background: '#f8f9fa',
                                padding: '20px',
                                borderRadius: '10px',
                                marginBottom: '20px'
                            }}>
                                <div style={{display: 'grid', gridTemplateColumns: '120px 1fr', gap: '15px', alignItems: 'center'}}>
                                    <span style={{color: '#666', fontSize: '14px'}}>Ïù¥Î©îÏùº</span>
                                    <span style={{fontWeight: '600', color: '#1a1a2e'}}>{user?.email || '-'}</span>
                                    
                                    <span style={{color: '#666', fontSize: '14px'}}>Ïó≠Ìï†</span>
                                    <span>
                                        <span style={{
                                            background: 'linear-gradient(135deg, #e94560 0%, #ff6b6b 100%)',
                                            color: 'white',
                                            padding: '4px 12px',
                                            borderRadius: '4px',
                                            fontSize: '12px',
                                            fontWeight: '600'
                                        }}>
                                            Í¥ÄÎ¶¨Ïûê
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω */}
                        <div className="settings-section" style={{borderBottom: 'none', paddingBottom: 0}}>
                            <h3 className="section-title">ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</h3>
                            <p style={{color: '#666', fontSize: '14px', marginBottom: '20px'}}>
                                ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤ΩÏùÑ ÏúÑÌï¥ Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏ Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.
                            </p>
                            
                            <form onSubmit={handlePasswordChange}>
                                <div style={{maxWidth: '400px'}}>
                                    <div className="form-group">
                                        <label style={{color: '#e94560'}}>Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏ *</label>
                                        <input
                                            type="password"
                                            value={uniquePassword}
                                            onChange={(e) => setUniquePassword(e.target.value)}
                                            placeholder="Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                            disabled={isChangingPassword}
                                        />
                                        <p style={{fontSize: '12px', color: '#999', marginTop: '4px'}}>
                                            Round Í¥ÄÎ¶¨Ïóê ÏÇ¨Ïö©ÎêòÎäî Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏ÏûÖÎãàÎã§
                                        </p>
                                    </div>
                                    
                                    <div style={{
                                        borderTop: '1px solid #eee',
                                        marginTop: '20px',
                                        paddingTop: '20px'
                                    }}>
                                        <div className="form-group">
                                            <label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ *</label>
                                            <input
                                                type="password"
                                                value={newPassword}
                                                onChange={(e) => setNewPassword(e.target.value)}
                                                placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ (6Ïûê Ïù¥ÏÉÅ)"
                                                disabled={isChangingPassword}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ *</label>
                                            <input
                                                type="password"
                                                value={confirmPassword}
                                                onChange={(e) => setConfirmPassword(e.target.value)}
                                                placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ Îã§Ïãú ÏûÖÎ†•"
                                                disabled={isChangingPassword}
                                            />
                                        </div>
                                    </div>
                                    
                                    {passwordMessage.text && (
                                        <div style={{
                                            padding: '12px 16px',
                                            borderRadius: '8px',
                                            marginBottom: '15px',
                                            background: passwordMessage.type === 'success' ? '#d4edda' : '#f8d7da',
                                            color: passwordMessage.type === 'success' ? '#155724' : '#721c24',
                                            fontSize: '14px'
                                        }}>
                                            {passwordMessage.text}
                                        </div>
                                    )}
                                    
                                    <button 
                                        type="submit" 
                                        className="btn"
                                        disabled={isChangingPassword}
                                        style={{marginTop: '10px'}}
                                    >
                                        {isChangingPassword ? 'Î≥ÄÍ≤Ω Ï§ë...' : 'ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // ÏÇ¨Ïù¥ÎìúÎ∞î Ïª¥Ìè¨ÎÑåÌä∏
        function Sidebar({ currentPage, setCurrentPage, user, onLogout, onRoundAccess }) {
            const menuItems = [
                { id: 'cost', name: 'ÎßàÏºÄÌåÖ ÎπÑÏö©', icon: Icons.Cost },
                { id: 'round', name: 'Round Í¥ÄÎ¶¨', icon: Icons.Round },
                { id: 'users', name: 'ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨', icon: Icons.Users },
                { id: 'settings', name: 'ÏÑ§Ï†ï', icon: Icons.Settings }
            ];

            // Î©îÎâ¥ ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨
            const handleMenuClick = (itemId) => {
                if (itemId === 'round') {
                    onRoundAccess();
                } else {
                    setCurrentPage(itemId);
                }
            };

            return (
                <aside className="sidebar">
                    <div className="sidebar-header">
                        <div className="admin-badge">ADMIN</div>
                        <h1>Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ</h1>
                        <p>Marketing Cost Compilater</p>
                    </div>

                    <nav className="sidebar-nav">
                        {menuItems.map(item => (
                            <div
                                key={item.id}
                                className={`nav-item ${currentPage === item.id ? 'active' : ''}`}
                                onClick={() => handleMenuClick(item.id)}
                            >
                                <item.icon />
                                <span>{item.name}</span>
                            </div>
                        ))}
                    </nav>

                    <div className="sidebar-footer">
                        <div className="user-info-sidebar">
                            <div className="user-avatar">
                                {user?.email?.charAt(0).toUpperCase()}
                            </div>
                            <div className="user-details">
                                <div className="name">{user?.email}</div>
                                <div className="role">Í¥ÄÎ¶¨Ïûê</div>
                            </div>
                        </div>
                        <button className="logout-btn" onClick={onLogout}>
                            Î°úÍ∑∏ÏïÑÏõÉ
                        </button>
                    </div>
                </aside>
            );
        }

        // Î©îÏù∏ Ïï± Ïª¥Ìè¨ÎÑåÌä∏
        function App() {
            const [currentPage, setCurrentPage] = useState('cost');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // Round Í¥ÄÎ¶¨ Ï†ëÍ∑º Í¥ÄÎ†® ÏÉÅÌÉú
            const [showRoundPasswordModal, setShowRoundPasswordModal] = useState(false);
            const [roundPassword, setRoundPassword] = useState('');
            const [roundAccessGranted, setRoundAccessGranted] = useState(false);
            const [isVerifying, setIsVerifying] = useState(false);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    // ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± Ï§ëÏù¥Î©¥ Î¶¨Îã§Ïù¥Î†âÌä∏Îßå ÌïòÏßÄ ÏïäÏùå (ÏÉÅÌÉúÎäî ÏóÖÎç∞Ïù¥Ìä∏)
                    if (isCreatingUser) {
                        console.log('ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± Ï§ë... Î¶¨Îã§Ïù¥Î†âÌä∏ Ïä§ÌÇµ');
                        // Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ïÏù¥Î©¥ ÏÉÅÌÉúÎßå ÏóÖÎç∞Ïù¥Ìä∏
                        if (currentUser && currentUser.email === ADMIN_EMAIL) {
                            setUser(currentUser);
                            setLoading(false);
                        }
                        return;
                    }
                    
                    if (!currentUser) {
                        window.location.href = 'index.html';
                    } else if (currentUser.email !== ADMIN_EMAIL) {
                        window.location.href = 'user.html';
                    } else {
                        setUser(currentUser);
                        setLoading(false);
                    }
                });

                return () => unsubscribe();
            }, []);

            // Round Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ Ï†ëÍ∑º ÏãúÎèÑ
            const handleRoundAccess = () => {
                if (roundAccessGranted) {
                    setCurrentPage('round');
                } else {
                    setRoundPassword('');
                    setShowRoundPasswordModal(true);
                }
            };

            // Round ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ (FirestoreÏóêÏÑú Í≤ÄÏ¶ù)
            const handleRoundPasswordSubmit = async (e) => {
                e.preventDefault();
                setIsVerifying(true);
                
                try {
                    // FirestoreÏóêÏÑú ÎπÑÎ∞ÄÎ≤àÌò∏ Í∞ÄÏ†∏Ïò§Í∏∞
                    const doc = await db.collection('settings').doc('roundPassword').get();
                    
                    if (!doc.exists) {
                        // ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÉùÏÑ±
                        await db.collection('settings').doc('roundPassword').set({
                            password: 'round1234',
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('Round ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ï¥àÍ∏∞ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§. Í∏∞Î≥∏ ÎπÑÎ∞ÄÎ≤àÌò∏: round1234');
                        setIsVerifying(false);
                        return;
                    }
                    
                    const storedPassword = doc.data().password;
                    
                    if (roundPassword === storedPassword) {
                        setRoundAccessGranted(true);
                        setShowRoundPasswordModal(false);
                        setCurrentPage('round');
                        setRoundPassword('');
                    } else {
                        alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
                        setRoundPassword('');
                    }
                } catch (error) {
                    console.error('ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ Ïò§Î•ò:', error);
                    alert('ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                } finally {
                    setIsVerifying(false);
                }
            };

            const handleLogout = async () => {
                if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    const result = await logout();
                    if (result.success) {
                        window.location.href = 'index.html';
                    } else {
                        alert('Î°úÍ∑∏ÏïÑÏõÉ Ïã§Ìå®: ' + result.message);
                    }
                }
            };

            if (loading) {
                return <div className="loading">Î°úÎî© Ï§ë...</div>;
            }

            const renderPage = () => {
                switch (currentPage) {
                    case 'cost':
                        return <MarketingCostPage />;
                    case 'round':
                        return <RoundManagementPage />;
                    case 'users':
                        return <UsersPage />;
                    case 'settings':
                        return <SettingsPage />;
                    default:
                        return <MarketingCostPage />;
                }
            };

            return (
                <div className="app-container">
                    <Sidebar
                        currentPage={currentPage}
                        setCurrentPage={setCurrentPage}
                        user={user}
                        onLogout={handleLogout}
                        onRoundAccess={handleRoundAccess}
                    />
                    <main className="main-content">
                        {renderPage()}
                    </main>

                    {/* Round Í¥ÄÎ¶¨ ÎπÑÎ∞ÄÎ≤àÌò∏ Î™®Îã¨ */}
                    {showRoundPasswordModal && (
                        <div className="modal-overlay" onClick={() => setShowRoundPasswordModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3>üîí Round Í¥ÄÎ¶¨ Ï†ëÍ∑º</h3>
                                    <button className="modal-close" onClick={() => setShowRoundPasswordModal(false)}>√ó</button>
                                </div>
                                <form onSubmit={handleRoundPasswordSubmit}>
                                    <div className="modal-body">
                                        <p style={{marginBottom: '15px', color: '#666'}}>
                                            Round Í¥ÄÎ¶¨Ïóê Ï†ëÍ∑ºÌïòÎ†§Î©¥ Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.
                                        </p>
                                        <div className="form-group">
                                            <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                                            <input 
                                                type="password"
                                                value={roundPassword}
                                                onChange={(e) => setRoundPassword(e.target.value)}
                                                placeholder="Í≥†Ïú† ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                                required
                                                autoFocus
                                            />
                                        </div>
                                    </div>
                                    <div className="modal-actions" style={{padding: '15px 20px', borderTop: '1px solid #eee', display: 'flex', gap: '10px', justifyContent: 'flex-end'}}>
                                        <button 
                                            type="button" 
                                            className="btn btn-secondary btn-sm"
                                            onClick={() => setShowRoundPasswordModal(false)}
                                            disabled={isVerifying}
                                        >
                                            Ï∑®ÏÜå
                                        </button>
                                        <button 
                                            type="submit" 
                                            className="btn btn-sm"
                                            disabled={isVerifying}
                                        >
                                            {isVerifying ? 'ÌôïÏù∏ Ï§ë...' : 'ÌôïÏù∏'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // React Î†åÎçîÎßÅ
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
